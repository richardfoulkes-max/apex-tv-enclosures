<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apex CRM - Apex Enclosures</title>
    <style>
        :root {
            --primary: #1e3a5f;
            --accent: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --purple: #8b5cf6;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 240px;
            right: 0;
            z-index: 100;
            height: 60px;
        }
        .header h1 { font-size: 1.25rem; }
        .header-stats { display: flex; gap: 1.5rem; }
        .stat { text-align: center; }
        .stat-value { font-size: 1.25rem; font-weight: 700; }
        .stat-label { font-size: 0.7rem; opacity: 0.8; }

        /* Main Layout - Master/Detail */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
            margin-top: 60px;
        }

        /* Left Panel - Partner List */
        .list-panel {
            width: 400px;
            min-width: 350px;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            background: white;
        }
        .list-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            background: #f8fafc;
        }
        .search-box {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .search-input {
            flex: 1;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .search-input:focus { outline: none; border-color: var(--accent); }
        .filter-row {
            display: flex;
            gap: 0.5rem;
        }
        .filter-select {
            flex: 1;
            padding: 0.4rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.8rem;
            background: white;
        }
        .partner-list {
            flex: 1;
            overflow-y: auto;
        }
        .partner-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.15s;
        }
        .partner-item:hover { background: #f1f5f9; }
        .partner-item.active { background: #eff6ff; border-left: 3px solid var(--accent); }
        .partner-name { font-weight: 600; font-size: 0.95rem; color: var(--text); }
        .partner-meta { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; }
        .partner-badges { display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap; }

        /* Right Panel - Detail View */
        .detail-panel {
            flex: 1;
            overflow-y: auto;
            background: var(--bg);
        }
        .detail-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            font-size: 1.1rem;
        }
        .detail-content {
            max-width: 900px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }
        .detail-title { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .detail-subtitle { color: var(--text-muted); margin-top: 0.25rem; }
        .detail-actions { display: flex; gap: 0.5rem; }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 10px;
            border: 1px solid var(--border);
            margin-bottom: 1rem;
        }
        .card-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-body { padding: 1rem; }

        /* Form Elements */
        .form-row { display: flex; gap: 1rem; margin-bottom: 0.75rem; }
        .form-group { flex: 1; }
        .form-group.full { flex: 100%; }
        .form-label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.25rem; text-transform: uppercase; }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent); }
        .form-textarea { min-height: 80px; resize: vertical; }
        .form-value { font-size: 0.95rem; padding: 0.25rem 0; }

        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover { background: #f8fafc; }
        .btn-small { padding: 0.35rem 0.75rem; font-size: 0.8rem; }
        .btn-icon { padding: 0.4rem; min-width: 32px; justify-content: center; }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .badge-status-not-contacted { background: #f1f5f9; color: #64748b; }
        .badge-status-contacted { background: #dbeafe; color: #1e40af; }
        .badge-status-responded { background: #fef3c7; color: #92400e; }
        .badge-status-meeting { background: #e0e7ff; color: #4338ca; }
        .badge-status-quoted { background: #fce7f3; color: #9d174d; }
        .badge-status-won { background: #dcfce7; color: #166534; }
        .badge-status-lost { background: #fee2e2; color: #991b1b; }

        .badge-type-fabricator { background: #dbeafe; color: #1e40af; }
        .badge-type-av-integrator { background: #fae8ff; color: #86198f; }
        .badge-type-pool-landscape { background: #ccfbf1; color: #4f46e5; }
        .badge-type-hospitality { background: #fef3c7; color: #b45309; }
        .badge-type-designer { background: #fce7f3; color: #9d174d; }
        .badge-type-developer { background: #e0e7ff; color: #4f46e5; }
        .badge-type-distributor { background: #dcfce7; color: #166534; }
        .badge-type-contractor { background: #fef3c7; color: #92400e; }
        .badge-type-other { background: #f1f5f9; color: #64748b; }

        .badge-priority-high { background: #fee2e2; color: #991b1b; }
        .badge-priority-medium { background: #fef3c7; color: #92400e; }
        .badge-priority-low { background: #f1f5f9; color: #64748b; }

        /* Contacts List */
        .contact-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: #fafafa;
        }
        .contact-info { flex: 1; }
        .contact-name { font-weight: 600; font-size: 0.9rem; }
        .contact-title { font-size: 0.8rem; color: var(--text-muted); }
        .contact-details { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; }
        .contact-badges { margin-top: 0.25rem; }
        .badge-dm { background: #dcfce7; color: #166534; font-size: 0.65rem; }
        .badge-primary { background: #dbeafe; color: #1e40af; font-size: 0.65rem; }

        /* Deal Section */
        .deal-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        .deal-stat { text-align: center; padding: 1rem; background: #f8fafc; border-radius: 8px; }
        .deal-stat-value { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .deal-stat-label { font-size: 0.75rem; color: var(--text-muted); }
        .products-interested { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem; }
        .product-tag { background: var(--accent); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; }
        .product-tag.inactive { background: #e2e8f0; color: #64748b; }

        /* Activity Timeline */
        .activity-timeline { position: relative; padding-left: 1.5rem; }
        .activity-timeline::before {
            content: '';
            position: absolute;
            left: 0.5rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }
        .activity-item {
            position: relative;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
        }
        .activity-item::before {
            content: '';
            position: absolute;
            left: -1.25rem;
            top: 1rem;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent);
            border: 2px solid white;
        }
        .activity-item.type-call::before { background: #10b981; }
        .activity-item.type-email_sent::before { background: #2563eb; }
        .activity-item.type-email_received::before { background: #8b5cf6; }
        .activity-item.type-meeting::before { background: #f59e0b; }
        .activity-item.type-demo::before { background: #ec4899; }
        .activity-item.type-quote_sent::before { background: #14b8a6; }
        .activity-item.type-site_visit::before { background: #f97316; }
        .activity-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; }
        .activity-type { font-weight: 600; font-size: 0.85rem; }
        .activity-date { font-size: 0.75rem; color: var(--text-muted); }
        .activity-desc { font-size: 0.85rem; color: var(--text); }

        /* Add Activity Form */
        .add-activity-form {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: 8px;
        }
        .add-activity-form select { width: 140px; }
        .add-activity-form input { flex: 1; }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .modal-title { font-size: 1.1rem; font-weight: 600; }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid var(--border);
            margin-bottom: 1rem;
        }
        .tab {
            padding: 0.75rem 1.25rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-muted);
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        .tab:hover { color: var(--text); }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* New Partner Button */
        .new-partner-btn {
            width: 100%;
            padding: 0.75rem;
            margin: 1rem 1rem 0 1rem;
            width: calc(100% - 2rem);
        }

        /* Contact Type Badges */
        .badge-contact-manufacturing { background: #fef3c7; color: #92400e; }
        .badge-contact-partner { background: #dbeafe; color: #1e40af; }
        .badge-contact-commercial { background: #e0e7ff; color: #4f46e5; }
        .badge-contact-retail { background: #dcfce7; color: #166534; }

        /* Responsive */
        @media (max-width: 900px) {
            .list-panel { width: 100%; position: absolute; z-index: 50; height: 100%; }
            .detail-panel { display: none; }
            .detail-panel.active { display: block; position: absolute; left: 0; right: 0; z-index: 60; }
            .back-btn { display: block !important; }
        }
        .back-btn { display: none; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>Apex CRM</h1>
        <div class="header-stats">
            <div class="stat"><div class="stat-value" id="totalPartners">0</div><div class="stat-label">Total</div></div>
            <div class="stat"><div class="stat-value" id="activeDeals">0</div><div class="stat-label">Active</div></div>
            <div class="stat"><div class="stat-value" id="pipelineValue">0</div><div class="stat-label">Pipeline</div></div>
            <div class="stat"><div class="stat-value" id="followupsToday">0</div><div class="stat-label">Follow-ups</div></div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Panel - Partner List -->
        <div class="list-panel">
            <div class="list-header">
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search partners..." oninput="renderList()">
                    <button class="btn btn-primary btn-icon" onclick="showNewPartnerModal()">+</button>
                </div>
                <div class="filter-row">
                    <select class="filter-select" id="contactTypeFilter" onchange="setContactTypeFilter(this.value)">
                        <option value="">All Contacts</option>
                        <option value="manufacturing">Manufacturing</option>
                        <option value="partner">Partners</option>
                        <option value="commercial">Commercial</option>
                        <option value="retail">Retail</option>
                    </select>
                    <select class="filter-select" id="typeFilter" onchange="renderList()">
                        <option value="">All Types</option>
                        <option value="Fabricator">Fabricator</option>
                        <option value="AV Integrator">AV Integrator</option>
                        <option value="Pool/Landscape">Pool/Landscape</option>
                        <option value="Hospitality">Hospitality</option>
                        <option value="Designer">Designer</option>
                        <option value="Developer">Developer</option>
                        <option value="Distributor">Distributor</option>
                        <option value="Contractor">Contractor</option>
                    </select>
                    <select class="filter-select" id="statusFilter" onchange="renderList()">
                        <option value="">All Status</option>
                        <option value="Not Contacted">Not Contacted</option>
                        <option value="Contacted">Contacted</option>
                        <option value="Responded">Responded</option>
                        <option value="Meeting">Meeting</option>
                        <option value="Quoted">Quoted</option>
                        <option value="Won">Won</option>
                        <option value="Lost">Lost</option>
                    </select>
                    <select class="filter-select" id="regionFilter" onchange="renderList()">
                        <option value="">All Regions</option>
                        <option value="UAE">UAE</option>
                        <option value="GCC">GCC</option>
                        <option value="China">China</option>
                        <option value="Europe">Europe</option>
                        <option value="USA">USA</option>
                    </select>
                </div>
            </div>
            <div class="partner-list" id="partnerList"></div>
        </div>

        <!-- Right Panel - Detail View -->
        <div class="detail-panel" id="detailPanel">
            <div class="detail-empty" id="detailEmpty">
                Select a partner to view details
            </div>
            <div class="detail-content" id="detailContent" style="display: none;"></div>
        </div>
    </div>

    <!-- New Partner Modal -->
    <div class="modal-overlay" id="newPartnerModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Add New Partner</span>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="newPartnerForm" onsubmit="createPartner(event)">
                <div class="form-group" style="margin-bottom: 0.75rem;">
                    <label class="form-label">Company Name *</label>
                    <input type="text" class="form-input" id="newCompanyName" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Contact Type *</label>
                        <select class="form-select" id="newContactType" required>
                            <option value="manufacturing">Manufacturing</option>
                            <option value="partner">Partner</option>
                            <option value="commercial">Commercial</option>
                            <option value="retail">Retail</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Region *</label>
                        <select class="form-select" id="newRegion" required>
                            <option value="UAE">UAE</option>
                            <option value="GCC">GCC</option>
                            <option value="China">China</option>
                            <option value="Europe">Europe</option>
                            <option value="USA">USA</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 0.75rem;">
                    <label class="form-label">Business Type *</label>
                    <select class="form-select" id="newPartnerType" required>
                        <option value="Fabricator">Fabricator</option>
                        <option value="AV Integrator">AV Integrator</option>
                        <option value="Pool/Landscape">Pool/Landscape</option>
                        <option value="Hospitality">Hospitality</option>
                        <option value="Designer">Designer</option>
                        <option value="Developer">Developer</option>
                        <option value="Distributor">Distributor</option>
                        <option value="Contractor">Contractor</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Contact Name</label>
                        <input type="text" class="form-input" id="newContactName">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="newEmail">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="text" class="form-input" id="newPhone">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Website</label>
                        <input type="url" class="form-input" id="newWebsite" placeholder="https://...">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 0.75rem;">
                    <label class="form-label">Lead Source</label>
                    <select class="form-select" id="newLeadSource">
                        <option value="cold_outreach">Cold Outreach</option>
                        <option value="linkedin">LinkedIn</option>
                        <option value="referral">Referral</option>
                        <option value="website">Website</option>
                        <option value="trade_show">Trade Show</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="newNotes" rows="2"></textarea>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button type="submit" class="btn btn-primary">Create Partner</button>
                    <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Contact Modal -->
    <div class="modal-overlay" id="addContactModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Add Contact</span>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="addContactForm" onsubmit="addContact(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-input" id="contactName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Job Title</label>
                        <input type="text" class="form-input" id="contactTitle" placeholder="e.g. Sales Manager">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="contactEmail">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="text" class="form-input" id="contactPhone">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label"><input type="checkbox" id="contactIsPrimary"> Primary Contact</label>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><input type="checkbox" id="contactIsDecisionMaker"> Decision Maker</label>
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button type="submit" class="btn btn-primary">Add Contact</button>
                    <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ============ SUPABASE CONFIGURATION ============
        const SUPABASE_STORAGE_KEY = 'apex_supabase_config';
        let supabaseClient = null;
        let useSupabase = false;

        function initSupabase() {
            const saved = localStorage.getItem(SUPABASE_STORAGE_KEY);
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    if (config.url && config.key) {
                        supabaseClient = window.supabase.createClient(config.url, config.key);
                        useSupabase = true;
                        console.log('Supabase connected for CRM');
                        updateConnectionBadge(true);
                    }
                } catch (e) {
                    console.warn('Supabase config invalid');
                }
            }
            if (!useSupabase) {
                updateConnectionBadge(false);
            }
        }

        function updateConnectionBadge(connected) {
            // Badge hidden - not needed for normal use
        }

        // ============ DATA LAYER ============
        let partners = [];
        let selectedPartnerId = null;
        let contactTypeFilter = ''; // '', 'manufacturing', 'partner', 'commercial', 'retail'

        // Activity type labels
        const activityTypes = {
            'note': 'Note',
            'call': 'Call',
            'email_sent': 'Email Sent',
            'email_received': 'Email Received',
            'meeting': 'Meeting',
            'demo': 'Demo',
            'quote_sent': 'Quote Sent',
            'site_visit': 'Site Visit'
        };

        // Initial data - migrated from old format
        const initialPartners = [
            {
                id: 1,
                companyName: 'Al Shurooq',
                contactType: 'partner',
                partnerType: 'Fabricator',
                region: 'UAE',
                website: 'https://alshurooq.ae',
                linkedInUrl: '',
                address: 'Dubai, UAE',
                leadSource: 'cold_outreach',
                status: 'Responded',
                priority: 'High',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 40,
                lostReason: '',
                followupDate: '2025-01-02',
                notes: 'Confirmed will prepare quote under individual name. Can fabricate aluminum enclosure but cannot do IP66 certification - may need to source sealing separately. AWAITING QUOTE.',
                contacts: [
                    { id: 1, name: 'Danica Sison', title: 'Sales', email: 'info@alshurooq.ae', phone: '+971 4 42 55988', isPrimary: true, isDecisionMaker: false }
                ],
                activities: [
                    { id: 1, type: 'email_sent', description: 'RFQ sent via email', timestamp: '2025-12-24T20:00:00Z' },
                    { id: 2, type: 'email_received', description: 'Response received - reviewing tech package, asked for Trade License', timestamp: '2025-12-26T10:44:00Z' },
                    { id: 3, type: 'email_sent', description: 'Confirmed proceeding as individual. Preparing quotation.', timestamp: '2025-12-26T14:44:00Z' }
                ],
                createdAt: '2025-12-24T20:00:00Z',
                lastContact: '2025-12-26T14:44:00Z'
            },
            {
                id: 2,
                companyName: 'Eurotech FZCO',
                contactType: 'partner',
                partnerType: 'Fabricator',
                region: 'UAE',
                website: 'https://eurotech-metal.com',
                linkedInUrl: '',
                address: 'JAFZA, Dubai, UAE',
                leadSource: 'cold_outreach',
                status: 'Contacted',
                priority: 'High',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 20,
                lostReason: '',
                followupDate: '2025-01-02',
                notes: 'Sheet metal, powder coating, panels. JAFZA Dubai location.',
                contacts: [
                    { id: 1, name: '', title: '', email: 'general@eurotech-metal.com', phone: '+971 4 883 0333', isPrimary: true, isDecisionMaker: false }
                ],
                activities: [
                    { id: 1, type: 'email_sent', description: 'RFQ sent via email', timestamp: '2025-12-24T20:00:00Z' }
                ],
                createdAt: '2025-12-24T20:00:00Z',
                lastContact: '2025-12-24T20:00:00Z'
            },
            {
                id: 3,
                companyName: 'Al Amazon Industries',
                contactType: 'partner',
                partnerType: 'Fabricator',
                region: 'UAE',
                website: 'https://www.alamazonuae.com',
                linkedInUrl: '',
                address: 'Sharjah, UAE',
                leadSource: 'cold_outreach',
                status: 'Contacted',
                priority: 'High',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 30,
                lostReason: '',
                followupDate: '2025-01-02',
                notes: 'HIGH FIT - Already makes aluminum enclosures & electrical cabinets. Has own powder coating plant. Custom specs to DEWA/ADDC standards.',
                contacts: [
                    { id: 1, name: '', title: '', email: 'alamazonuae@gmail.com', phone: '+971 6 535 5667', isPrimary: true, isDecisionMaker: false }
                ],
                activities: [
                    { id: 1, type: 'email_sent', description: 'RFQ sent via email', timestamp: '2025-12-24T08:00:00Z' }
                ],
                createdAt: '2025-12-24T08:00:00Z',
                lastContact: '2025-12-24T08:00:00Z'
            },
            {
                id: 4,
                companyName: 'KDM Steel',
                contactType: 'partner',
                partnerType: 'Fabricator',
                region: 'China',
                website: 'https://www.kdmsteel.com',
                linkedInUrl: '',
                address: 'Wuxi, Jiangsu, China',
                leadSource: 'cold_outreach',
                status: 'Responded',
                priority: 'High',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 50,
                lostReason: '',
                followupDate: '2025-01-03',
                notes: 'TOP PICK - Pure OEM fabricator. 10+ years, ISO 9001, makes outdoor enclosures to spec. Responded on WhatsApp - will follow up.',
                contacts: [
                    { id: 1, name: '', title: 'Sales', email: 'sales@kdmsteel.com', phone: '+86-13175970882', isPrimary: true, isDecisionMaker: false }
                ],
                activities: [
                    { id: 1, type: 'email_sent', description: 'RFQ sent via email + WhatsApp follow-up', timestamp: '2025-12-28T10:00:00Z' },
                    { id: 2, type: 'email_received', description: 'WhatsApp response received - said they will follow up', timestamp: '2025-12-28T14:00:00Z' }
                ],
                createdAt: '2025-12-28T10:00:00Z',
                lastContact: '2025-12-28T14:00:00Z'
            },
            {
                id: 5,
                companyName: 'Flezco',
                contactType: 'partner',
                partnerType: 'Fabricator',
                region: 'GCC',
                website: 'https://www.flezco.com',
                linkedInUrl: '',
                address: 'Jeddah, Saudi Arabia',
                leadSource: 'cold_outreach',
                status: 'Contacted',
                priority: 'High',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 25,
                lostReason: '',
                followupDate: '2025-01-02',
                notes: 'HIGH FIT - Saudi Jeddah + nationwide. Sheet metal for enclosures, machinery panels.',
                contacts: [
                    { id: 1, name: '', title: '', email: 'hello@flezco.com', phone: '+966 50 830 4644', isPrimary: true, isDecisionMaker: false }
                ],
                activities: [
                    { id: 1, type: 'email_sent', description: 'RFQ sent via email', timestamp: '2025-12-24T08:00:00Z' }
                ],
                createdAt: '2025-12-24T08:00:00Z',
                lastContact: '2025-12-24T08:00:00Z'
            },
            // Sales Partners
            {
                id: 101,
                companyName: 'Pulse Cinemas Middle East',
                contactType: 'partner',
                partnerType: 'AV Integrator',
                region: 'UAE',
                website: 'https://www.pulsecinemas.com',
                linkedInUrl: '',
                address: 'Dubai, UAE',
                leadSource: 'cold_outreach',
                status: 'Not Contacted',
                priority: 'High',
                dealValue: 50000,
                productsInterested: ['75"', '65"'],
                expectedCloseDate: '',
                winProbability: 0,
                lostReason: '',
                followupDate: '',
                notes: 'Luxury home cinema installation. Perfect partner for high-end residential market.',
                contacts: [],
                activities: [],
                createdAt: '2025-12-31T21:00:00Z',
                lastContact: null
            },
            {
                id: 102,
                companyName: 'Almoe AV Systems',
                contactType: 'partner',
                partnerType: 'AV Integrator',
                region: 'UAE',
                website: 'https://www.almoe.com',
                linkedInUrl: '',
                address: 'Dubai, UAE',
                leadSource: 'cold_outreach',
                status: 'Not Contacted',
                priority: 'High',
                dealValue: 75000,
                productsInterested: ['75"', '65"', '55"'],
                expectedCloseDate: '',
                winProbability: 0,
                lostReason: '',
                followupDate: '',
                notes: 'AV integration, smart homes. Major player in UAE market.',
                contacts: [
                    { id: 1, name: '', title: '', email: 'info@almoe.com', phone: '+971 4 339 4455', isPrimary: true, isDecisionMaker: false }
                ],
                activities: [],
                createdAt: '2025-12-31T21:00:00Z',
                lastContact: null
            },
            {
                id: 103,
                companyName: 'Emaar Properties',
                contactType: 'commercial',
                partnerType: 'Developer',
                region: 'UAE',
                website: 'https://www.emaar.com',
                linkedInUrl: 'https://www.linkedin.com/company/emaar',
                address: 'Dubai, UAE',
                leadSource: 'cold_outreach',
                status: 'Not Contacted',
                priority: 'High',
                dealValue: 500000,
                productsInterested: ['75"', '65"'],
                expectedCloseDate: '',
                winProbability: 0,
                lostReason: '',
                followupDate: '',
                notes: 'Largest developer in UAE. Target for bulk orders in new developments with outdoor entertainment areas.',
                contacts: [],
                activities: [],
                createdAt: '2025-12-31T21:00:00Z',
                lastContact: null
            },
            {
                id: 104,
                companyName: 'Bishop Design',
                contactType: 'partner',
                partnerType: 'Designer',
                region: 'UAE',
                website: 'https://www.bishopdesign.com',
                linkedInUrl: '',
                address: 'Dubai, UAE',
                leadSource: 'cold_outreach',
                status: 'Not Contacted',
                priority: 'Medium',
                dealValue: 25000,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 0,
                lostReason: '',
                followupDate: '',
                notes: 'Hospitality-focused interior design. Many hotel/restaurant projects.',
                contacts: [],
                activities: [],
                createdAt: '2025-12-31T21:00:00Z',
                lastContact: null
            },
            {
                id: 105,
                companyName: 'Desert Dreams Landscaping',
                contactType: 'contractor',
                partnerType: 'Pool/Landscape',
                region: 'UAE',
                website: '',
                linkedInUrl: '',
                address: 'Dubai, UAE',
                leadSource: 'cold_outreach',
                status: 'Not Contacted',
                priority: 'Medium',
                dealValue: 35000,
                productsInterested: ['75"', '65"'],
                expectedCloseDate: '',
                winProbability: 0,
                lostReason: '',
                followupDate: '',
                notes: 'Pool and outdoor living specialists. Good referral partner for residential installations.',
                contacts: [],
                activities: [],
                createdAt: '2025-12-31T21:00:00Z',
                lastContact: null
            }
        ];

        // ============ STORAGE ============
        async function loadData() {
            if (useSupabase) {
                try {
                    // Load partners from Supabase
                    const { data: partnersData, error: pError } = await supabaseClient
                        .from('partners')
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (!pError && partnersData && partnersData.length > 0) {
                        // Load contacts and activities for each partner
                        const partnerIds = partnersData.map(p => p.id);

                        const { data: contactsData } = await supabaseClient
                            .from('partner_contacts')
                            .select('*')
                            .in('partner_id', partnerIds);

                        const { data: activitiesData } = await supabaseClient
                            .from('partner_activities')
                            .select('*')
                            .in('partner_id', partnerIds)
                            .order('timestamp', { ascending: false });

                        // Transform to local format
                        partners = partnersData.map(p => ({
                            id: p.id,
                            companyName: p.company_name,
                            contactType: p.contact_type || 'partner',
                            partnerType: p.partner_type,
                            region: p.region,
                            website: p.website,
                            linkedInUrl: p.linkedin_url,
                            address: p.address,
                            leadSource: p.lead_source,
                            status: p.status,
                            priority: p.priority,
                            dealValue: parseFloat(p.deal_value) || 0,
                            winProbability: p.win_probability,
                            expectedCloseDate: p.expected_close_date,
                            lostReason: p.lost_reason,
                            productsInterested: p.products_interested || [],
                            followupDate: p.followup_date,
                            notes: p.notes,
                            contacts: (contactsData || [])
                                .filter(c => c.partner_id === p.id)
                                .map(c => ({
                                    id: c.id,
                                    name: c.name,
                                    title: c.title,
                                    email: c.email,
                                    phone: c.phone,
                                    isPrimary: c.is_primary,
                                    isDecisionMaker: c.is_decision_maker
                                })),
                            activities: (activitiesData || [])
                                .filter(a => a.partner_id === p.id)
                                .map(a => ({
                                    id: a.id,
                                    type: a.activity_type,
                                    description: a.description,
                                    timestamp: a.timestamp
                                })),
                            createdAt: p.created_at,
                            lastContact: p.last_contact
                        }));
                        console.log(`Loaded ${partners.length} partners from Supabase`);
                        return;
                    }
                } catch (e) {
                    console.warn('Supabase load failed, using localStorage', e);
                }
            }

            // Fallback to localStorage
            const stored = localStorage.getItem('apexCrmData');
            const version = localStorage.getItem('apexCrmVersion');

            if (version !== 'v6' || !stored) {
                // Initialize with new data structure (v6 adds contactType)
                partners = initialPartners;
                saveData();
                localStorage.setItem('apexCrmVersion', 'v6');
            } else {
                partners = JSON.parse(stored);
                // Ensure all partners have contactType (migration)
                partners.forEach(p => {
                    if (!p.contactType) {
                        p.contactType = 'partner'; // Default for existing partners
                    }
                });
            }
        }

        function saveData() {
            // Always save to localStorage as backup
            localStorage.setItem('apexCrmData', JSON.stringify(partners));
        }

        // Save a partner to Supabase
        async function savePartnerToSupabase(partner) {
            if (!useSupabase) return;

            try {
                // Check if partner exists (has UUID format id)
                const isExisting = typeof partner.id === 'string' && partner.id.includes('-');

                const partnerData = {
                    company_name: partner.companyName,
                    contact_type: partner.contactType || 'partner',
                    partner_type: partner.partnerType,
                    region: partner.region,
                    website: partner.website,
                    linkedin_url: partner.linkedInUrl,
                    address: partner.address,
                    lead_source: partner.leadSource,
                    status: partner.status,
                    priority: partner.priority,
                    deal_value: partner.dealValue,
                    win_probability: partner.winProbability,
                    expected_close_date: partner.expectedCloseDate || null,
                    lost_reason: partner.lostReason,
                    products_interested: partner.productsInterested,
                    followup_date: partner.followupDate || null,
                    notes: partner.notes,
                    last_contact: partner.lastContact
                };

                let partnerId;
                if (isExisting) {
                    // Update existing
                    await supabaseClient.from('partners').update(partnerData).eq('id', partner.id);
                    partnerId = partner.id;
                } else {
                    // Insert new
                    const { data } = await supabaseClient.from('partners').insert(partnerData).select('id').single();
                    if (data) partnerId = data.id;
                }

                // Sync contacts if we have a partnerId
                if (partnerId && partner.contacts?.length > 0) {
                    // Delete existing contacts and re-insert
                    await supabaseClient.from('partner_contacts').delete().eq('partner_id', partnerId);

                    const contactsData = partner.contacts.map(c => ({
                        partner_id: partnerId,
                        name: c.name,
                        title: c.title,
                        email: c.email,
                        phone: c.phone,
                        is_primary: c.isPrimary,
                        is_decision_maker: c.isDecisionMaker
                    }));
                    await supabaseClient.from('partner_contacts').insert(contactsData);
                }

                console.log('Partner saved to Supabase');
            } catch (e) {
                console.error('Supabase save error:', e);
            }
        }

        // Save an activity to Supabase
        async function saveActivityToSupabase(partnerId, activity) {
            if (!useSupabase) return;

            try {
                await supabaseClient.from('partner_activities').insert({
                    partner_id: partnerId,
                    activity_type: activity.type,
                    description: activity.description,
                    timestamp: activity.timestamp
                });
                console.log('Activity saved to Supabase');
            } catch (e) {
                console.error('Activity save error:', e);
            }
        }

        // ============ LIST VIEW ============
        function renderList() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const regionFilter = document.getElementById('regionFilter').value;

            let filtered = partners.filter(p => {
                // Contact type filter (from tabs)
                if (contactTypeFilter && p.contactType !== contactTypeFilter) return false;
                // Search
                if (search && !p.companyName.toLowerCase().includes(search) &&
                    !p.notes?.toLowerCase().includes(search)) return false;
                if (typeFilter && p.partnerType !== typeFilter) return false;
                if (statusFilter && p.status !== statusFilter) return false;
                if (regionFilter && p.region !== regionFilter) return false;
                return true;
            });

            // Sort by priority then name
            filtered.sort((a, b) => {
                const priorityOrder = { 'High': 0, 'Medium': 1, 'Low': 2 };
                const pA = priorityOrder[a.priority] ?? 2;
                const pB = priorityOrder[b.priority] ?? 2;
                if (pA !== pB) return pA - pB;
                return a.companyName.localeCompare(b.companyName);
            });

            const listHtml = filtered.map(p => {
                const typeClass = 'badge-type-' + p.partnerType.toLowerCase().replace(/[\s\/]+/g, '-');
                const statusClass = 'badge-status-' + p.status.toLowerCase().replace(/\s+/g, '-');
                const contactTypeClass = 'badge-contact-' + (p.contactType || 'partner');
                const contactTypeLabel = { manufacturing: 'Manufacturing', partner: 'Partner', commercial: 'Commercial', retail: 'Retail' }[p.contactType] || 'Partner';
                const primaryContact = p.contacts?.find(c => c.isPrimary) || p.contacts?.[0];

                return `
                    <div class="partner-item ${selectedPartnerId === p.id ? 'active' : ''}" onclick="selectPartner(${p.id})">
                        <div class="partner-name">${p.companyName}</div>
                        <div class="partner-meta">${primaryContact?.name || 'No contact'} &middot; ${p.region}</div>
                        <div class="partner-badges">
                            <span class="badge ${contactTypeClass}">${contactTypeLabel}</span>
                            <span class="badge ${typeClass}">${p.partnerType}</span>
                            <span class="badge ${statusClass}">${p.status}</span>
                            ${p.priority === 'High' ? '<span class="badge badge-priority-high">High</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('partnerList').innerHTML = listHtml || '<div style="padding: 2rem; text-align: center; color: var(--text-muted);">No partners found</div>';
            updateStats();
            updateTypeCounts();
        }

        // Contact type filter
        function setContactTypeFilter(type) {
            contactTypeFilter = type;
            renderList();
        }

        // Update contact type counts (no-op, tabs removed)
        function updateTypeCounts() {}

        function updateStats() {
            document.getElementById('totalPartners').textContent = partners.length;

            const active = partners.filter(p => !['Won', 'Lost', 'Not Contacted'].includes(p.status)).length;
            document.getElementById('activeDeals').textContent = active;

            const pipeline = partners.reduce((sum, p) => sum + (p.dealValue || 0), 0);
            document.getElementById('pipelineValue').textContent = pipeline > 0 ? (pipeline / 1000).toFixed(0) + 'K' : '0';

            const today = new Date().toISOString().split('T')[0];
            const followups = partners.filter(p => p.followupDate && p.followupDate <= today).length;
            document.getElementById('followupsToday').textContent = followups;
        }

        // ============ DETAIL VIEW ============
        function selectPartner(id) {
            selectedPartnerId = id;
            renderList();
            renderDetail();
            document.getElementById('detailPanel').classList.add('active');
        }

        function renderDetail() {
            const p = partners.find(p => p.id === selectedPartnerId);
            if (!p) {
                document.getElementById('detailEmpty').style.display = 'flex';
                document.getElementById('detailContent').style.display = 'none';
                return;
            }

            document.getElementById('detailEmpty').style.display = 'none';
            document.getElementById('detailContent').style.display = 'block';

            const typeClass = 'badge-type-' + p.partnerType.toLowerCase().replace(/[\s\/]+/g, '-');
            const statusClass = 'badge-status-' + p.status.toLowerCase().replace(/\s+/g, '-');
            const contactTypeClass = 'badge-contact-' + (p.contactType || 'partner');
            const contactTypeLabel = { manufacturing: 'Manufacturing', partner: 'Partner', commercial: 'Commercial', retail: 'Retail' }[p.contactType] || 'Partner';

            const html = `
                <button class="btn btn-outline back-btn" onclick="closeDetail()" style="margin-bottom: 1rem;">&larr; Back</button>

                <div class="detail-header">
                    <div>
                        <div class="detail-title">${p.companyName}</div>
                        <div class="detail-subtitle">
                            <span class="badge ${contactTypeClass}">${contactTypeLabel}</span>
                            <span class="badge ${typeClass}">${p.partnerType}</span>
                            <span class="badge ${statusClass}">${p.status}</span>
                            <span class="badge badge-priority-${p.priority.toLowerCase()}">${p.priority} Priority</span>
                        </div>
                    </div>
                    <div class="detail-actions">
                        <button class="btn btn-outline btn-small" onclick="editPartnerField('status')">Update Status</button>
                        <button class="btn btn-danger btn-small" onclick="deletePartner(${p.id})">Delete</button>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('overview')">Overview</button>
                    <button class="tab" onclick="switchTab('contacts')">Contacts (${p.contacts?.length || 0})</button>
                    <button class="tab" onclick="switchTab('deal')">Deal</button>
                    <button class="tab" onclick="switchTab('activity')">Activity (${p.activities?.length || 0})</button>
                </div>

                <!-- Overview Tab -->
                <div class="tab-content active" id="tab-overview">
                    <div class="card">
                        <div class="card-header">Company Information</div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Website</label>
                                    <div class="form-value">${p.website ? `<a href="${p.website}" target="_blank">${p.website}</a>` : '-'}</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">LinkedIn</label>
                                    <div class="form-value">${p.linkedInUrl ? `<a href="${p.linkedInUrl}" target="_blank">View Profile</a>` : '-'}</div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Address</label>
                                    <div class="form-value">${p.address || '-'}</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Lead Source</label>
                                    <div class="form-value">${p.leadSource?.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) || '-'}</div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Follow-up Date</label>
                                    <div class="form-value">${p.followupDate ? formatDate(p.followupDate) : '-'}</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Last Contact</label>
                                    <div class="form-value">${p.lastContact ? formatDate(p.lastContact) : 'Never'}</div>
                                </div>
                            </div>
                            <button class="btn btn-outline btn-small" onclick="showEditCompanyModal()">Edit Company Info</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">Notes</div>
                        <div class="card-body">
                            <textarea class="form-textarea" id="partnerNotes" onblur="saveNotes()" style="min-height: 100px;">${p.notes || ''}</textarea>
                        </div>
                    </div>
                </div>

                <!-- Contacts Tab -->
                <div class="tab-content" id="tab-contacts">
                    <div class="card">
                        <div class="card-header">
                            <span>Contacts</span>
                            <button class="btn btn-primary btn-small" onclick="showAddContactModal()">+ Add Contact</button>
                        </div>
                        <div class="card-body">
                            ${p.contacts?.length ? p.contacts.map(c => `
                                <div class="contact-item">
                                    <div class="contact-info">
                                        <div class="contact-name">${c.name || 'Unnamed Contact'}</div>
                                        <div class="contact-title">${c.title || 'No title'}</div>
                                        <div class="contact-details">
                                            ${c.email ? `<a href="mailto:${c.email}">${c.email}</a>` : ''}
                                            ${c.email && c.phone ? ' &middot; ' : ''}
                                            ${c.phone || ''}
                                        </div>
                                        <div class="contact-badges">
                                            ${c.isPrimary ? '<span class="badge badge-primary">Primary</span>' : ''}
                                            ${c.isDecisionMaker ? '<span class="badge badge-dm">Decision Maker</span>' : ''}
                                        </div>
                                    </div>
                                    <button class="btn btn-outline btn-small" onclick="deleteContact(${c.id})">Remove</button>
                                </div>
                            `).join('') : '<div style="text-align: center; color: var(--text-muted); padding: 2rem;">No contacts yet. Add one to get started.</div>'}
                        </div>
                    </div>
                </div>

                <!-- Deal Tab -->
                <div class="tab-content" id="tab-deal">
                    <div class="card">
                        <div class="card-header">
                            <span>Deal Information</span>
                            <button class="btn btn-outline btn-small" onclick="showEditDealModal()">Edit Deal</button>
                        </div>
                        <div class="card-body">
                            <div class="deal-grid">
                                <div class="deal-stat">
                                    <div class="deal-stat-value">AED ${(p.dealValue || 0).toLocaleString()}</div>
                                    <div class="deal-stat-label">Deal Value</div>
                                </div>
                                <div class="deal-stat">
                                    <div class="deal-stat-value">${p.winProbability || 0}%</div>
                                    <div class="deal-stat-label">Win Probability</div>
                                </div>
                                <div class="deal-stat">
                                    <div class="deal-stat-value">${p.expectedCloseDate ? formatDate(p.expectedCloseDate) : '-'}</div>
                                    <div class="deal-stat-label">Expected Close</div>
                                </div>
                            </div>
                            <div style="margin-top: 1rem;">
                                <label class="form-label">Products Interested</label>
                                <div class="products-interested">
                                    ${['55"', '65"', '75"'].map(size => `
                                        <span class="product-tag ${p.productsInterested?.includes(size) ? '' : 'inactive'}">${size}</span>
                                    `).join('')}
                                </div>
                            </div>
                            ${p.status === 'Lost' && p.lostReason ? `
                                <div style="margin-top: 1rem; padding: 0.75rem; background: #fee2e2; border-radius: 6px;">
                                    <strong>Lost Reason:</strong> ${p.lostReason}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>

                <!-- Activity Tab -->
                <div class="tab-content" id="tab-activity">
                    <div class="card">
                        <div class="card-header">Activity Timeline</div>
                        <div class="card-body">
                            <div class="add-activity-form">
                                <select class="form-select" id="newActivityType">
                                    ${Object.entries(activityTypes).map(([k, v]) => `<option value="${k}">${v}</option>`).join('')}
                                </select>
                                <input type="text" class="form-input" id="newActivityDesc" placeholder="Describe the activity...">
                                <button class="btn btn-primary" onclick="addActivity()">Add</button>
                            </div>

                            <div class="activity-timeline">
                                ${p.activities?.length ? [...p.activities].reverse().map(a => `
                                    <div class="activity-item type-${a.type}">
                                        <div class="activity-header">
                                            <span class="activity-type">${activityTypes[a.type] || a.type}</span>
                                            <span class="activity-date">${formatDateTime(a.timestamp)}</span>
                                        </div>
                                        <div class="activity-desc">${a.description}</div>
                                    </div>
                                `).join('') : '<div style="text-align: center; color: var(--text-muted); padding: 2rem;">No activities yet.</div>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('detailContent').innerHTML = html;
        }

        function closeDetail() {
            selectedPartnerId = null;
            document.getElementById('detailPanel').classList.remove('active');
            document.getElementById('detailEmpty').style.display = 'flex';
            document.getElementById('detailContent').style.display = 'none';
            renderList();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + tabId).classList.add('active');
        }

        // ============ CRUD OPERATIONS ============
        function showNewPartnerModal() {
            document.getElementById('newPartnerForm').reset();
            document.getElementById('newPartnerModal').classList.add('active');
        }

        function showAddContactModal() {
            document.getElementById('addContactForm').reset();
            document.getElementById('addContactModal').classList.add('active');
        }

        function closeModal() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
        }

        function createPartner(e) {
            e.preventDefault();

            const newPartner = {
                id: Date.now(),
                companyName: document.getElementById('newCompanyName').value,
                contactType: document.getElementById('newContactType').value,
                partnerType: document.getElementById('newPartnerType').value,
                region: document.getElementById('newRegion').value,
                website: document.getElementById('newWebsite').value || '',
                linkedInUrl: '',
                address: '',
                leadSource: document.getElementById('newLeadSource').value,
                status: 'Not Contacted',
                priority: 'Medium',
                dealValue: 0,
                productsInterested: [],
                expectedCloseDate: '',
                winProbability: 0,
                lostReason: '',
                followupDate: '',
                notes: document.getElementById('newNotes').value || '',
                contacts: [],
                activities: [],
                createdAt: new Date().toISOString(),
                lastContact: null
            };

            // Add contact if provided
            const contactName = document.getElementById('newContactName').value;
            const contactEmail = document.getElementById('newEmail').value;
            const contactPhone = document.getElementById('newPhone').value;

            if (contactName || contactEmail || contactPhone) {
                newPartner.contacts.push({
                    id: 1,
                    name: contactName,
                    title: '',
                    email: contactEmail,
                    phone: contactPhone,
                    isPrimary: true,
                    isDecisionMaker: false
                });
            }

            partners.push(newPartner);
            saveData();
            savePartnerToSupabase(newPartner);
            closeModal();
            selectPartner(newPartner.id);
        }

        function addContact(e) {
            e.preventDefault();
            const p = partners.find(p => p.id === selectedPartnerId);
            if (!p) return;

            const newContact = {
                id: Date.now(),
                name: document.getElementById('contactName').value,
                title: document.getElementById('contactTitle').value,
                email: document.getElementById('contactEmail').value,
                phone: document.getElementById('contactPhone').value,
                isPrimary: document.getElementById('contactIsPrimary').checked,
                isDecisionMaker: document.getElementById('contactIsDecisionMaker').checked
            };

            if (newContact.isPrimary) {
                p.contacts.forEach(c => c.isPrimary = false);
            }

            p.contacts.push(newContact);
            saveData();
            savePartnerToSupabase(p);
            closeModal();
            renderDetail();
            renderList();
        }

        function deleteContact(contactId) {
            if (!confirm('Remove this contact?')) return;
            const p = partners.find(p => p.id === selectedPartnerId);
            if (!p) return;
            p.contacts = p.contacts.filter(c => c.id !== contactId);
            saveData();
            savePartnerToSupabase(p);
            renderDetail();
        }

        function deletePartner(id) {
            if (!confirm('Delete this partner? This cannot be undone.')) return;
            partners = partners.filter(p => p.id !== id);
            saveData();
            closeDetail();
            renderList();
        }

        function saveNotes() {
            const p = partners.find(p => p.id === selectedPartnerId);
            if (!p) return;
            p.notes = document.getElementById('partnerNotes').value;
            saveData();
            savePartnerToSupabase(p);
        }

        function addActivity() {
            const p = partners.find(p => p.id === selectedPartnerId);
            if (!p) return;

            const type = document.getElementById('newActivityType').value;
            const desc = document.getElementById('newActivityDesc').value;
            if (!desc.trim()) return alert('Please enter a description');

            const activity = {
                id: Date.now(),
                type: type,
                description: desc,
                timestamp: new Date().toISOString()
            };

            p.activities = p.activities || [];
            p.activities.push(activity);
            p.lastContact = activity.timestamp;

            // Update status if needed
            if (p.status === 'Not Contacted') {
                p.status = 'Contacted';
            }

            saveData();
            savePartnerToSupabase(p);
            saveActivityToSupabase(p.id, activity);
            document.getElementById('newActivityDesc').value = '';
            renderDetail();
            renderList();
            switchTab('activity'); // Stay on activity tab
        }

        function editPartnerField(field) {
            const p = partners.find(p => p.id === selectedPartnerId);
            if (!p) return;

            if (field === 'status') {
                const statuses = ['Not Contacted', 'Contacted', 'Responded', 'Meeting', 'Quoted', 'Won', 'Lost'];
                const current = statuses.indexOf(p.status);
                const newStatus = prompt(`Current: ${p.status}\n\nEnter new status:\n${statuses.map((s, i) => `${i + 1}. ${s}`).join('\n')}`);

                if (newStatus && statuses[parseInt(newStatus) - 1]) {
                    p.status = statuses[parseInt(newStatus) - 1];

                    if (p.status === 'Lost') {
                        const reason = prompt('Why was this deal lost?');
                        if (reason) p.lostReason = reason;
                    }

                    saveData();
                    savePartnerToSupabase(p);
                    renderDetail();
                    renderList();
                }
            }
        }

        function showEditCompanyModal() {
            const p = partners.find(p => p.id === selectedPartnerId);
            if (!p) return;

            const html = `
                <div class="modal-overlay active" id="editCompanyModal" onclick="if(event.target===this)closeModal()">
                    <div class="modal">
                        <div class="modal-header">
                            <span class="modal-title">Edit Company Info</span>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <form onsubmit="saveCompanyInfo(event)">
                            <div class="form-group" style="margin-bottom: 0.75rem;">
                                <label class="form-label">Company Name *</label>
                                <input type="text" class="form-input" id="editCompanyName" value="${p.companyName}" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Type</label>
                                    <select class="form-select" id="editPartnerType">
                                        ${['Fabricator', 'AV Integrator', 'Pool/Landscape', 'Hospitality', 'Designer', 'Developer', 'Distributor', 'Contractor', 'Other'].map(t =>
                                            `<option value="${t}" ${p.partnerType === t ? 'selected' : ''}>${t}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Region</label>
                                    <select class="form-select" id="editRegion">
                                        ${['UAE', 'GCC', 'China', 'Europe', 'USA', 'Other'].map(r =>
                                            `<option value="${r}" ${p.region === r ? 'selected' : ''}>${r}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Website</label>
                                    <input type="url" class="form-input" id="editWebsite" value="${p.website || ''}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">LinkedIn</label>
                                    <input type="url" class="form-input" id="editLinkedIn" value="${p.linkedInUrl || ''}">
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 0.75rem;">
                                <label class="form-label">Address</label>
                                <input type="text" class="form-input" id="editAddress" value="${p.address || ''}">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Priority</label>
                                    <select class="form-select" id="editPriority">
                                        ${['Low', 'Medium', 'High'].map(pr =>
                                            `<option value="${pr}" ${p.priority === pr ? 'selected' : ''}>${pr}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Follow-up Date</label>
                                    <input type="date" class="form-input" id="editFollowup" value="${p.followupDate || ''}">
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                                <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function saveCompanyInfo(e) {
            e.preventDefault();
            const p = partners.find(p => p.id === selectedPartnerId);
            if (!p) return;

            p.companyName = document.getElementById('editCompanyName').value;
            p.partnerType = document.getElementById('editPartnerType').value;
            p.region = document.getElementById('editRegion').value;
            p.website = document.getElementById('editWebsite').value;
            p.linkedInUrl = document.getElementById('editLinkedIn').value;
            p.address = document.getElementById('editAddress').value;
            p.priority = document.getElementById('editPriority').value;
            p.followupDate = document.getElementById('editFollowup').value;

            saveData();
            savePartnerToSupabase(p);
            document.getElementById('editCompanyModal').remove();
            renderDetail();
            renderList();
        }

        function showEditDealModal() {
            const p = partners.find(p => p.id === selectedPartnerId);
            if (!p) return;

            const html = `
                <div class="modal-overlay active" id="editDealModal" onclick="if(event.target===this)closeModal()">
                    <div class="modal">
                        <div class="modal-header">
                            <span class="modal-title">Edit Deal Information</span>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <form onsubmit="saveDealInfo(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Deal Value (AED)</label>
                                    <input type="number" class="form-input" id="editDealValue" value="${p.dealValue || 0}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Win Probability (%)</label>
                                    <input type="number" class="form-input" id="editWinProb" min="0" max="100" value="${p.winProbability || 0}">
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 0.75rem;">
                                <label class="form-label">Expected Close Date</label>
                                <input type="date" class="form-input" id="editCloseDate" value="${p.expectedCloseDate || ''}">
                            </div>
                            <div class="form-group" style="margin-bottom: 0.75rem;">
                                <label class="form-label">Products Interested</label>
                                <div style="display: flex; gap: 1rem;">
                                    ${['55"', '65"', '75"'].map(size => `
                                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="checkbox" value="${size}" ${p.productsInterested?.includes(size) ? 'checked' : ''} class="productCheckbox">
                                            ${size}
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                                <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function saveDealInfo(e) {
            e.preventDefault();
            const p = partners.find(p => p.id === selectedPartnerId);
            if (!p) return;

            p.dealValue = parseInt(document.getElementById('editDealValue').value) || 0;
            p.winProbability = parseInt(document.getElementById('editWinProb').value) || 0;
            p.expectedCloseDate = document.getElementById('editCloseDate').value;
            p.productsInterested = Array.from(document.querySelectorAll('.productCheckbox:checked')).map(cb => cb.value);

            saveData();
            savePartnerToSupabase(p);
            document.getElementById('editDealModal').remove();
            renderDetail();
            renderList();
        }

        // ============ UTILITIES ============
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', async () => {
            initSupabase();
            await loadData();
            renderList();
        });

        // Close modals on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
    </script>
    <script src="nav.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="auth-guard.js"></script>
</body>
</html>
