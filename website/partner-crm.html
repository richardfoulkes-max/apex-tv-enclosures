<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apex TV Enclosures - Partner CRM</title>
    <style>
        :root {
            --primary: #1e3a5f;
            --accent: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --purple: #8b5cf6;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary), #2d4a6f);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 1.5rem; }
        .header-stats {
            display: flex;
            gap: 2rem;
        }
        .stat {
            text-align: center;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .stat-label {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        /* Main Content */
        .main-content { padding: 2rem; max-width: 1600px; margin: 0 auto; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.5rem;
        }
        .tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-muted);
            border-radius: 8px 8px 0 0;
            transition: all 0.2s;
        }
        .tab:hover { background: #f1f5f9; color: var(--text); }
        .tab.active { background: var(--accent); color: white; }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }
        .card-title { font-size: 1.1rem; font-weight: 600; color: var(--primary); }

        /* Form */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }
        .form-group { margin-bottom: 0.5rem; }
        .form-group.full { grid-column: span 4; }
        .form-group.half { grid-column: span 2; }
        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.25rem;
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .form-textarea { min-height: 80px; resize: vertical; }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Buttons */
        .btn {
            padding: 0.6rem 1.25rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 0.9rem;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-small { padding: 0.4rem 0.75rem; font-size: 0.8rem; }
        .btn-outline {
            background: white;
            border: 1px solid var(--border);
            color: var(--text);
        }
        .btn-outline:hover { background: #f8fafc; }

        /* Table */
        .table-container { overflow-x: auto; }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        .data-table th, .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .data-table th {
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.8rem;
            text-transform: uppercase;
            background: #f8fafc;
            position: sticky;
            top: 0;
        }
        .data-table tr:hover { background: #f8fafc; }
        .data-table tr.selected { background: #eff6ff; }

        /* Status Badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-not-contacted { background: #f1f5f9; color: #64748b; }
        .badge-contacted { background: #dbeafe; color: #1e40af; }
        .badge-responded { background: #fef3c7; color: #92400e; }
        .badge-meeting { background: #e0e7ff; color: #4338ca; }
        .badge-quoted { background: #fce7f3; color: #9d174d; }
        .badge-won { background: #dcfce7; color: #166534; }
        .badge-lost { background: #fee2e2; color: #991b1b; }

        /* Partner Type Badges */
        .type-fabricator { background: #dbeafe; color: #1e40af; }
        .type-distributor { background: #dcfce7; color: #166534; }
        .type-contractor { background: #fef3c7; color: #92400e; }
        .type-supplier { background: #e0e7ff; color: #4338ca; }
        .type-other { background: #f1f5f9; color: #64748b; }

        /* Filters */
        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .filter-label { font-size: 0.85rem; color: var(--text-muted); }
        .search-input {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            width: 250px;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }
        .modal-title { font-size: 1.1rem; font-weight: 600; }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        /* Activity Log */
        .activity-log {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem;
            background: #f8fafc;
        }
        .activity-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.85rem;
        }
        .activity-item:last-child { border-bottom: none; }
        .activity-date { color: var(--text-muted); font-size: 0.75rem; }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .summary-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }
        .summary-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .summary-card.active { border-color: var(--accent); background: #eff6ff; }
        .summary-count { font-size: 1.5rem; font-weight: 700; }
        .summary-label { font-size: 0.75rem; color: var(--text-muted); }

        /* Tab Panels */
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* Actions */
        .actions { display: flex; gap: 0.5rem; }

        @media (max-width: 1200px) {
            .form-grid { grid-template-columns: repeat(2, 1fr); }
            .form-group.full { grid-column: span 2; }
            .form-group.half { grid-column: span 1; }
            .summary-grid { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .form-group.full, .form-group.half { grid-column: span 1; }
            .summary-grid { grid-template-columns: repeat(2, 1fr); }
            .header { flex-direction: column; gap: 1rem; }
        }
        /* Navigation */
        .doc-nav {
            background: linear-gradient(135deg, #1e3a5f 0%, #0f1f3a 100%);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border);
        }
        .doc-nav h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(255,255,255,0.7);
            margin-bottom: 0.75rem;
        }
        .doc-nav-grid {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .doc-card {
            background: rgba(255,255,255,0.1);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            text-decoration: none;
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .doc-card:hover {
            background: rgba(255,255,255,0.2);
        }
        .doc-card.active {
            background: white;
            color: var(--primary);
        }

        /* Sortable headers */
        .sortable {
            cursor: pointer;
            user-select: none;
        }
        .sortable:hover {
            background: #e2e8f0;
        }
        .sort-arrow {
            margin-left: 4px;
            opacity: 0.5;
        }
        .sort-arrow.active {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="doc-nav">
        <h3>Manufacturing Documentation</h3>
        <div class="doc-nav-grid">
            <a href="index.html" class="doc-card">Website</a>
            <a href="specification.html" class="doc-card">Specification</a>
            <a href="bom-detailed.html" class="doc-card">Bill of Materials</a>
            <a href="project-tracker.html" class="doc-card">Project Tracker</a>
            <a href="china-suppliers.html" class="doc-card">China Suppliers</a>
            <a href="go-to-market.html" class="doc-card">Go-to-Market</a>
            <a href="partner-crm.html" class="doc-card active">Partner CRM</a>
        </div>
    </nav>

    <!-- Header -->
    <header class="header">
        <div>
            <h1>Apex TV Enclosures - Partner CRM</h1>
            <p style="opacity: 0.8; font-size: 0.9rem;">Track fabricators, distributors, and contractors</p>
        </div>
        <div class="header-stats">
            <div class="stat">
                <div class="stat-value" id="totalPartners">0</div>
                <div class="stat-label">Total Partners</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="activeDeals">0</div>
                <div class="stat-label">Active Deals</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="needsFollowup">0</div>
                <div class="stat-label">Needs Follow-up</div>
            </div>
        </div>
    </header>

    <main class="main-content">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('partners')">All Partners</button>
            <button class="tab" onclick="showTab('pipeline')">Pipeline</button>
            <button class="tab" onclick="showTab('add')">+ Add Partner</button>
        </div>

        <!-- Partners Tab -->
        <div id="partners" class="tab-panel active">
            <!-- Status Summary -->
            <div class="summary-grid">
                <div class="summary-card" onclick="filterByStatus('all')">
                    <div class="summary-count" id="countAll">0</div>
                    <div class="summary-label">All</div>
                </div>
                <div class="summary-card" onclick="filterByStatus('Not Contacted')">
                    <div class="summary-count" id="countNotContacted">0</div>
                    <div class="summary-label">Not Contacted</div>
                </div>
                <div class="summary-card" onclick="filterByStatus('Contacted')">
                    <div class="summary-count" id="countContacted">0</div>
                    <div class="summary-label">Contacted</div>
                </div>
                <div class="summary-card" onclick="filterByStatus('Responded')">
                    <div class="summary-count" id="countResponded">0</div>
                    <div class="summary-label">Responded</div>
                </div>
                <div class="summary-card" onclick="filterByStatus('Quoted')">
                    <div class="summary-count" id="countQuoted">0</div>
                    <div class="summary-label">Quoted</div>
                </div>
                <div class="summary-card" onclick="filterByStatus('Won')">
                    <div class="summary-count" id="countWon">0</div>
                    <div class="summary-label">Won</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <div class="filter-group">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search partners..." oninput="renderPartners()">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Type:</label>
                    <select class="form-select" id="typeFilter" style="width: 150px;" onchange="renderPartners()">
                        <option value="">All Types</option>
                        <option value="Fabricator">Fabricator</option>
                        <option value="Distributor">Distributor</option>
                        <option value="Contractor">Contractor</option>
                        <option value="Supplier">Supplier</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Region:</label>
                    <select class="form-select" id="regionFilter" style="width: 150px;" onchange="renderPartners()">
                        <option value="">All Regions</option>
                        <option value="UAE">UAE</option>
                        <option value="GCC">GCC</option>
                        <option value="China">China</option>
                        <option value="Europe">Europe</option>
                        <option value="USA">USA</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <button class="btn btn-outline btn-small" onclick="exportData()">Export CSV</button>
            </div>

            <!-- Partners Table -->
            <div class="card">
                <div class="table-container">
                    <table class="data-table" id="partnersTable">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortBy('companyName')">Company <span class="sort-arrow" id="sort-companyName">↕</span></th>
                                <th class="sortable" onclick="sortBy('partnerType')">Type <span class="sort-arrow" id="sort-partnerType">↕</span></th>
                                <th>Contact</th>
                                <th class="sortable" onclick="sortBy('region')">Region <span class="sort-arrow" id="sort-region">↕</span></th>
                                <th class="sortable" onclick="sortBy('status')">Status <span class="sort-arrow" id="sort-status">↕</span></th>
                                <th class="sortable" onclick="sortBy('lastContact')">Last Contact <span class="sort-arrow" id="sort-lastContact">↕</span></th>
                                <th class="sortable" onclick="sortBy('followupDate')">Follow-up <span class="sort-arrow" id="sort-followupDate">↕</span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="partnersBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Pipeline Tab -->
        <div id="pipeline" class="tab-panel">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Deal Pipeline</span>
                </div>
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem;" id="pipelineBoard">
                    <!-- Pipeline columns will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Add Partner Tab -->
        <div id="add" class="tab-panel">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Add New Partner</span>
                </div>
                <form id="partnerForm" onsubmit="savePartner(event)">
                    <div class="form-grid">
                        <div class="form-group half">
                            <label class="form-label">Company Name *</label>
                            <input type="text" class="form-input" id="companyName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Partner Type *</label>
                            <select class="form-select" id="partnerType" required>
                                <option value="">Select type...</option>
                                <option value="Fabricator">Fabricator</option>
                                <option value="Distributor">Distributor</option>
                                <option value="Contractor">Contractor</option>
                                <option value="Supplier">Supplier</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Region *</label>
                            <select class="form-select" id="region" required>
                                <option value="">Select region...</option>
                                <option value="UAE">UAE</option>
                                <option value="GCC">GCC</option>
                                <option value="China">China</option>
                                <option value="Europe">Europe</option>
                                <option value="USA">USA</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contact Name</label>
                            <input type="text" class="form-input" id="contactName">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="email">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="text" class="form-input" id="phone">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Website</label>
                            <input type="url" class="form-input" id="website" placeholder="https://">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="status">
                                <option value="Not Contacted">Not Contacted</option>
                                <option value="Contacted">Contacted</option>
                                <option value="Responded">Responded</option>
                                <option value="Meeting">Meeting Scheduled</option>
                                <option value="Quoted">Quoted</option>
                                <option value="Won">Won</option>
                                <option value="Lost">Lost</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Follow-up Date</label>
                            <input type="date" class="form-input" id="followupDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Priority</label>
                            <select class="form-select" id="priority">
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                            </select>
                        </div>
                        <div class="form-group full">
                            <label class="form-label">Notes</label>
                            <textarea class="form-textarea" id="notes" placeholder="Add any relevant notes..."></textarea>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                        <button type="submit" class="btn btn-primary">Save Partner</button>
                        <button type="button" class="btn btn-outline" onclick="clearForm()">Clear</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Edit Partner</span>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="editForm" onsubmit="updatePartner(event)">
                <input type="hidden" id="editId">
                <div class="form-grid">
                    <div class="form-group half">
                        <label class="form-label">Company Name *</label>
                        <input type="text" class="form-input" id="editCompanyName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Partner Type *</label>
                        <select class="form-select" id="editPartnerType" required>
                            <option value="Fabricator">Fabricator</option>
                            <option value="Distributor">Distributor</option>
                            <option value="Contractor">Contractor</option>
                            <option value="Supplier">Supplier</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Region *</label>
                        <select class="form-select" id="editRegion" required>
                            <option value="UAE">UAE</option>
                            <option value="GCC">GCC</option>
                            <option value="China">China</option>
                            <option value="Europe">Europe</option>
                            <option value="USA">USA</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contact Name</label>
                        <input type="text" class="form-input" id="editContactName">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="editEmail">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="text" class="form-input" id="editPhone">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Website</label>
                        <input type="url" class="form-input" id="editWebsite">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="editStatus">
                            <option value="Not Contacted">Not Contacted</option>
                            <option value="Contacted">Contacted</option>
                            <option value="Responded">Responded</option>
                            <option value="Meeting">Meeting Scheduled</option>
                            <option value="Quoted">Quoted</option>
                            <option value="Won">Won</option>
                            <option value="Lost">Lost</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Follow-up Date</label>
                        <input type="date" class="form-input" id="editFollowupDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-select" id="editPriority">
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                    <div class="form-group full">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" id="editNotes"></textarea>
                    </div>
                    <div class="form-group full">
                        <label class="form-label">Add Activity Note</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" class="form-input" id="activityNote" placeholder="Log a call, email, meeting...">
                            <button type="button" class="btn btn-outline" onclick="addActivity()">Add</button>
                        </div>
                    </div>
                    <div class="form-group full">
                        <label class="form-label">Activity History</label>
                        <div class="activity-log" id="activityLog"></div>
                    </div>
                </div>
                <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: space-between;">
                    <div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                    </div>
                    <button type="button" class="btn btn-danger" onclick="deletePartner()">Delete</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Data storage
        let partners = JSON.parse(localStorage.getItem('apexPartners')) || [];
        let currentFilter = 'all';
        let editingId = null;
        let sortField = 'companyName';
        let sortDirection = 'asc';

        // Initial data - companies already contacted
        const initialPartners = [
            {
                id: 1,
                companyName: 'Al Shurooq',
                partnerType: 'Fabricator',
                region: 'UAE',
                contactName: 'Danica Sison',
                email: 'info@alshurooq.ae',
                phone: '+971 4 42 55988',
                website: 'https://alshurooq.ae',
                status: 'Responded',
                followupDate: '2025-01-02',
                priority: 'High',
                notes: 'Confirmed will prepare quote under individual name. Can fabricate aluminum enclosure but cannot do IP66 certification - may need to source sealing separately. AWAITING QUOTE.',
                activities: [
                    { date: '2025-12-24T20:00:00Z', note: 'RFQ sent via email' },
                    { date: '2025-12-26T10:44:00Z', note: 'Response received - reviewing tech package, asked for Trade License' },
                    { date: '2025-12-26T14:44:00Z', note: 'Confirmed proceeding as individual. Preparing quotation.' }
                ],
                createdAt: '2025-12-24T20:00:00Z',
                lastContact: '2025-12-26T14:44:00Z'
            },
            {
                id: 2,
                companyName: 'Eurotech FZCO',
                partnerType: 'Fabricator',
                region: 'UAE',
                contactName: '',
                email: 'general@eurotech-metal.com',
                phone: '+971 4 883 0333',
                website: 'https://eurotech-metal.com',
                status: 'Contacted',
                followupDate: '2025-01-02',
                priority: 'High',
                notes: 'Sheet metal, powder coating, panels. JAFZA Dubai location.',
                activities: [
                    { date: '2025-12-24T20:00:00Z', note: 'RFQ sent via email' }
                ],
                createdAt: '2025-12-24T20:00:00Z',
                lastContact: '2025-12-24T20:00:00Z'
            },
            {
                id: 3,
                companyName: 'EmirFab',
                partnerType: 'Fabricator',
                region: 'UAE',
                contactName: '',
                email: 'sales@emirfab.com',
                phone: '+971 52 905 5245',
                website: '',
                status: 'Contacted',
                followupDate: '2025-01-02',
                priority: 'Medium',
                notes: 'Custom metal fabrication, aluminum specialist.',
                activities: [
                    { date: '2025-12-24T20:00:00Z', note: 'RFQ sent via email' }
                ],
                createdAt: '2025-12-24T20:00:00Z',
                lastContact: '2025-12-24T20:00:00Z'
            },
            {
                id: 4,
                companyName: 'Al Amazon Industries',
                partnerType: 'Fabricator',
                region: 'UAE',
                contactName: '',
                email: 'alamazonuae@gmail.com',
                phone: '+971 6 535 5667',
                website: 'https://www.alamazonuae.com',
                status: 'Contacted',
                followupDate: '2025-01-02',
                priority: 'High',
                notes: 'HIGH FIT - Already makes aluminum enclosures & electrical cabinets. Has own powder coating plant. Custom specs to DEWA/ADDC standards.',
                activities: [
                    { date: '2025-12-24T08:00:00Z', note: 'RFQ sent via email' }
                ],
                createdAt: '2025-12-24T08:00:00Z',
                lastContact: '2025-12-24T08:00:00Z'
            },
            {
                id: 5,
                companyName: 'Rainbow Aluminium',
                partnerType: 'Fabricator',
                region: 'UAE',
                contactName: '',
                email: 'info@rainbowaluminium.com',
                phone: '+971 6 743 6914',
                website: 'https://rainbowaluminium.com',
                status: 'Contacted',
                followupDate: '2025-01-02',
                priority: 'Medium',
                notes: 'GOOD FIT - Aluminum fabrication + own powder coating (200+ colors). 30+ years experience. Received duplicate email.',
                activities: [
                    { date: '2025-12-24T08:00:00Z', note: 'RFQ sent via email (x2 duplicate)' }
                ],
                createdAt: '2025-12-24T08:00:00Z',
                lastContact: '2025-12-24T08:00:00Z'
            },
            {
                id: 6,
                companyName: 'Saudi Modern Factory (SMF)',
                partnerType: 'Fabricator',
                region: 'GCC',
                contactName: '',
                email: 'info@smf.com.sa',
                phone: '',
                website: '',
                status: 'Contacted',
                followupDate: '2025-01-02',
                priority: 'Medium',
                notes: 'Saudi - Riyadh. Possibly delivered.',
                activities: [
                    { date: '2025-12-24T20:00:00Z', note: 'RFQ sent via email' }
                ],
                createdAt: '2025-12-24T20:00:00Z',
                lastContact: '2025-12-24T20:00:00Z'
            },
            {
                id: 7,
                companyName: 'Flezco',
                partnerType: 'Fabricator',
                region: 'GCC',
                contactName: '',
                email: 'hello@flezco.com',
                phone: '+966 50 830 4644',
                website: 'https://www.flezco.com',
                status: 'Contacted',
                followupDate: '2025-01-02',
                priority: 'High',
                notes: 'HIGH FIT - Saudi Jeddah + nationwide. Sheet metal for enclosures, machinery panels. Received duplicate email.',
                activities: [
                    { date: '2025-12-24T08:00:00Z', note: 'RFQ sent via email (x2 duplicate)' }
                ],
                createdAt: '2025-12-24T08:00:00Z',
                lastContact: '2025-12-24T08:00:00Z'
            },
            {
                id: 8,
                companyName: 'Lucky Fabricators',
                partnerType: 'Fabricator',
                region: 'GCC',
                contactName: 'Hamza',
                email: 'hamza@luckyfabricators.sa',
                phone: '+966 54 218 4642',
                website: 'https://luckyfabricators.sa',
                status: 'Contacted',
                followupDate: '2025-01-02',
                priority: 'High',
                notes: 'HIGH FIT - Saudi Riyadh. Precision aluminum work, laser/water jet cutting, anodizing. Aerospace & electronics. Received duplicate email.',
                activities: [
                    { date: '2025-12-24T08:00:00Z', note: 'RFQ sent via email (x2 duplicate)' }
                ],
                createdAt: '2025-12-24T08:00:00Z',
                lastContact: '2025-12-24T08:00:00Z'
            },
            {
                id: 9,
                companyName: 'Prisma Metal Industry',
                partnerType: 'Fabricator',
                region: 'GCC',
                contactName: '',
                email: 'prisma@prismaksa.com',
                phone: '+966 13 890 1419',
                website: 'https://prisma-ksa.com',
                status: 'Contacted',
                followupDate: '2025-01-02',
                priority: 'Medium',
                notes: 'GOOD FIT - Saudi Dammam. 35 years experience, 38,000m² factory. May be oversized for initial volumes. Received duplicate email.',
                activities: [
                    { date: '2025-12-24T08:00:00Z', note: 'RFQ sent via email (x2 duplicate)' }
                ],
                createdAt: '2025-12-24T08:00:00Z',
                lastContact: '2025-12-24T08:00:00Z'
            },
            {
                id: 10,
                companyName: 'KDM Steel',
                partnerType: 'Fabricator',
                region: 'China',
                contactName: '',
                email: 'sales@kdmsteel.com',
                phone: '+86-13175970882',
                website: 'https://www.kdmsteel.com',
                status: 'Responded',
                followupDate: '2025-01-03',
                priority: 'High',
                notes: 'TOP PICK - Pure OEM fabricator. 10+ years, ISO 9001, makes outdoor enclosures to spec. Responded on WhatsApp - will follow up.',
                activities: [
                    { date: '2025-12-28T10:00:00Z', note: 'RFQ sent via email + WhatsApp follow-up' },
                    { date: '2025-12-28T14:00:00Z', note: 'WhatsApp response received - said they will follow up' }
                ],
                createdAt: '2025-12-28T10:00:00Z',
                lastContact: '2025-12-28T14:00:00Z'
            }
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Always load initial partners (version 3 - updated 28 Dec 2025)
            const dataVersion = localStorage.getItem('apexPartnersVersion');
            if (dataVersion !== 'v3') {
                partners = initialPartners;
                localStorage.setItem('apexPartnersVersion', 'v3');
                saveData();
            }
            renderPartners();
            updateStats();
        });

        // Show Tab
        function showTab(tabId) {
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');

            if (tabId === 'pipeline') renderPipeline();
        }

        // Save Partner
        function savePartner(e) {
            e.preventDefault();
            const partner = {
                id: Date.now(),
                companyName: document.getElementById('companyName').value,
                partnerType: document.getElementById('partnerType').value,
                region: document.getElementById('region').value,
                contactName: document.getElementById('contactName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                website: document.getElementById('website').value,
                status: document.getElementById('status').value,
                followupDate: document.getElementById('followupDate').value,
                priority: document.getElementById('priority').value,
                notes: document.getElementById('notes').value,
                activities: [{
                    date: new Date().toISOString(),
                    note: 'Partner added to CRM'
                }],
                createdAt: new Date().toISOString(),
                lastContact: null
            };

            partners.push(partner);
            saveData();
            clearForm();
            showTab('partners');
            document.querySelector('.tab').click();
            alert('Partner saved successfully!');
        }

        // Clear Form
        function clearForm() {
            document.getElementById('partnerForm').reset();
        }

        // Render Partners Table
        function renderPartners() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const regionFilter = document.getElementById('regionFilter').value;

            let filtered = partners.filter(p => {
                const matchSearch = p.companyName.toLowerCase().includes(search) ||
                                   (p.contactName && p.contactName.toLowerCase().includes(search)) ||
                                   (p.email && p.email.toLowerCase().includes(search));
                const matchType = !typeFilter || p.partnerType === typeFilter;
                const matchRegion = !regionFilter || p.region === regionFilter;
                const matchStatus = currentFilter === 'all' || p.status === currentFilter;
                return matchSearch && matchType && matchRegion && matchStatus;
            });

            // Sort the filtered results
            filtered.sort((a, b) => {
                let aVal = a[sortField] || '';
                let bVal = b[sortField] || '';
                if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                if (typeof bVal === 'string') bVal = bVal.toLowerCase();
                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            // Update sort arrows
            document.querySelectorAll('.sort-arrow').forEach(el => {
                el.textContent = '↕';
                el.classList.remove('active');
            });
            const activeArrow = document.getElementById('sort-' + sortField);
            if (activeArrow) {
                activeArrow.textContent = sortDirection === 'asc' ? '↑' : '↓';
                activeArrow.classList.add('active');
            }

            const tbody = document.getElementById('partnersBody');
            tbody.innerHTML = filtered.map(p => `
                <tr style="cursor: pointer;" onclick="editPartner(${p.id})">
                    <td>
                        <strong style="color: var(--accent);">${p.companyName}</strong>
                        ${p.website ? `<br><a href="${p.website}" target="_blank" style="font-size: 0.8rem; color: var(--text-muted);" onclick="event.stopPropagation()">Website ↗</a>` : ''}
                    </td>
                    <td><span class="badge type-${p.partnerType.toLowerCase()}">${p.partnerType}</span></td>
                    <td>
                        ${p.contactName || '-'}
                        ${p.email ? `<br><a href="mailto:${p.email}" style="font-size: 0.8rem;" onclick="event.stopPropagation()">${p.email}</a>` : ''}
                        ${p.phone ? `<br><span style="font-size: 0.8rem; color: var(--text-muted);">${p.phone}</span>` : ''}
                    </td>
                    <td>${p.region}</td>
                    <td><span class="badge badge-${p.status.toLowerCase().replace(' ', '-')}">${p.status}</span></td>
                    <td>${p.lastContact ? formatDate(p.lastContact) : '-'}</td>
                    <td>${p.followupDate ? formatDate(p.followupDate) : '-'}</td>
                    <td class="actions" onclick="event.stopPropagation()">
                        <button class="btn btn-outline btn-small" onclick="editPartner(${p.id})">Edit</button>
                        <button class="btn btn-small" style="background: var(--success); color: white;" onclick="quickStatus(${p.id})">Update</button>
                    </td>
                </tr>
            `).join('');

            updateStats();
        }

        // Sort by field
        function sortBy(field) {
            if (sortField === field) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDirection = 'asc';
            }
            renderPartners();
        }

        // Filter by Status
        function filterByStatus(status) {
            currentFilter = status;
            document.querySelectorAll('.summary-card').forEach(c => c.classList.remove('active'));
            event.target.closest('.summary-card').classList.add('active');
            renderPartners();
        }

        // Update Stats
        function updateStats() {
            document.getElementById('totalPartners').textContent = partners.length;
            document.getElementById('countAll').textContent = partners.length;

            const statuses = ['Not Contacted', 'Contacted', 'Responded', 'Quoted', 'Won'];
            statuses.forEach(s => {
                const count = partners.filter(p => p.status === s).length;
                const id = 'count' + s.replace(' ', '');
                if (document.getElementById(id)) {
                    document.getElementById(id).textContent = count;
                }
            });

            // Active deals (not Won or Lost)
            const active = partners.filter(p => !['Won', 'Lost', 'Not Contacted'].includes(p.status)).length;
            document.getElementById('activeDeals').textContent = active;

            // Needs followup (past due or today)
            const today = new Date().toISOString().split('T')[0];
            const needsFollowup = partners.filter(p => p.followupDate && p.followupDate <= today && !['Won', 'Lost'].includes(p.status)).length;
            document.getElementById('needsFollowup').textContent = needsFollowup;
        }

        // Edit Partner
        function editPartner(id) {
            const partner = partners.find(p => p.id === id);
            if (!partner) return;

            editingId = id;
            document.getElementById('editId').value = id;
            document.getElementById('editCompanyName').value = partner.companyName;
            document.getElementById('editPartnerType').value = partner.partnerType;
            document.getElementById('editRegion').value = partner.region;
            document.getElementById('editContactName').value = partner.contactName || '';
            document.getElementById('editEmail').value = partner.email || '';
            document.getElementById('editPhone').value = partner.phone || '';
            document.getElementById('editWebsite').value = partner.website || '';
            document.getElementById('editStatus').value = partner.status;
            document.getElementById('editFollowupDate').value = partner.followupDate || '';
            document.getElementById('editPriority').value = partner.priority || 'Medium';
            document.getElementById('editNotes').value = partner.notes || '';

            // Render activities
            const activityLog = document.getElementById('activityLog');
            activityLog.innerHTML = (partner.activities || []).reverse().map(a => `
                <div class="activity-item">
                    <div class="activity-date">${formatDateTime(a.date)}</div>
                    <div>${a.note}</div>
                </div>
            `).join('') || '<p style="color: var(--text-muted); font-size: 0.85rem;">No activities logged yet.</p>';

            document.getElementById('editModal').classList.add('active');
        }

        // Update Partner
        function updatePartner(e) {
            e.preventDefault();
            const index = partners.findIndex(p => p.id === editingId);
            if (index === -1) return;

            const oldStatus = partners[index].status;
            const newStatus = document.getElementById('editStatus').value;

            partners[index] = {
                ...partners[index],
                companyName: document.getElementById('editCompanyName').value,
                partnerType: document.getElementById('editPartnerType').value,
                region: document.getElementById('editRegion').value,
                contactName: document.getElementById('editContactName').value,
                email: document.getElementById('editEmail').value,
                phone: document.getElementById('editPhone').value,
                website: document.getElementById('editWebsite').value,
                status: newStatus,
                followupDate: document.getElementById('editFollowupDate').value,
                priority: document.getElementById('editPriority').value,
                notes: document.getElementById('editNotes').value,
                lastContact: new Date().toISOString()
            };

            // Log status change
            if (oldStatus !== newStatus) {
                partners[index].activities = partners[index].activities || [];
                partners[index].activities.push({
                    date: new Date().toISOString(),
                    note: `Status changed from "${oldStatus}" to "${newStatus}"`
                });
            }

            saveData();
            closeModal();
            renderPartners();
        }

        // Add Activity
        function addActivity() {
            const note = document.getElementById('activityNote').value;
            if (!note) return;

            const index = partners.findIndex(p => p.id === editingId);
            if (index === -1) return;

            partners[index].activities = partners[index].activities || [];
            partners[index].activities.push({
                date: new Date().toISOString(),
                note: note
            });
            partners[index].lastContact = new Date().toISOString();

            saveData();
            document.getElementById('activityNote').value = '';
            editPartner(editingId); // Refresh modal
        }

        // Quick Status Update
        function quickStatus(id) {
            const partner = partners.find(p => p.id === id);
            if (!partner) return;

            const statuses = ['Not Contacted', 'Contacted', 'Responded', 'Meeting', 'Quoted', 'Won', 'Lost'];
            const currentIndex = statuses.indexOf(partner.status);
            const nextStatus = statuses[currentIndex + 1] || statuses[0];

            if (confirm(`Update status to "${nextStatus}"?`)) {
                const index = partners.findIndex(p => p.id === id);
                partners[index].status = nextStatus;
                partners[index].lastContact = new Date().toISOString();
                partners[index].activities = partners[index].activities || [];
                partners[index].activities.push({
                    date: new Date().toISOString(),
                    note: `Status updated to "${nextStatus}"`
                });
                saveData();
                renderPartners();
            }
        }

        // Delete Partner
        function deletePartner() {
            if (confirm('Are you sure you want to delete this partner?')) {
                partners = partners.filter(p => p.id !== editingId);
                saveData();
                closeModal();
                renderPartners();
            }
        }

        // Close Modal
        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
            editingId = null;
        }

        // Render Pipeline
        function renderPipeline() {
            const stages = [
                { name: 'Not Contacted', color: '#64748b' },
                { name: 'Contacted', color: '#2563eb' },
                { name: 'Responded', color: '#f59e0b' },
                { name: 'Quoted', color: '#8b5cf6' },
                { name: 'Won', color: '#10b981' }
            ];

            const board = document.getElementById('pipelineBoard');
            board.innerHTML = stages.map(stage => {
                const stagePartners = partners.filter(p => p.status === stage.name);
                return `
                    <div style="background: #f8fafc; border-radius: 8px; padding: 1rem;">
                        <div style="font-weight: 600; margin-bottom: 1rem; color: ${stage.color};">
                            ${stage.name} (${stagePartners.length})
                        </div>
                        ${stagePartners.map(p => `
                            <div style="background: white; border-radius: 6px; padding: 0.75rem; margin-bottom: 0.5rem; border: 1px solid var(--border); cursor: pointer;" onclick="editPartner(${p.id})">
                                <div style="font-weight: 500; font-size: 0.9rem;">${p.companyName}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">${p.partnerType} - ${p.region}</div>
                                ${p.followupDate ? `<div style="font-size: 0.75rem; color: ${new Date(p.followupDate) <= new Date() ? 'var(--danger)' : 'var(--text-muted)'}; margin-top: 0.25rem;">Follow-up: ${formatDate(p.followupDate)}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }).join('');
        }

        // Export CSV
        function exportData() {
            const headers = ['Company', 'Type', 'Region', 'Contact', 'Email', 'Phone', 'Website', 'Status', 'Follow-up', 'Priority', 'Notes'];
            const rows = partners.map(p => [
                p.companyName,
                p.partnerType,
                p.region,
                p.contactName || '',
                p.email || '',
                p.phone || '',
                p.website || '',
                p.status,
                p.followupDate || '',
                p.priority || '',
                (p.notes || '').replace(/"/g, '""')
            ]);

            const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${c}"`).join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `apex-partners-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // Save Data
        function saveData() {
            localStorage.setItem('apexPartners', JSON.stringify(partners));
        }

        // Format Date
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        // Close modal on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>
</html>
