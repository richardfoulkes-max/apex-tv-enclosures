<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apex CRM - Apex Enclosures</title>
    <style>
        :root {
            --primary: #1e3a5f;
            --accent: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --purple: #8b5cf6;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 240px;
            right: 0;
            z-index: 100;
            height: 60px;
        }
        .header h1 { font-size: 1.25rem; }
        .header-stats { display: flex; gap: 1.5rem; }
        .stat { text-align: center; }
        .stat-value { font-size: 1.25rem; font-weight: 700; }
        .stat-label { font-size: 0.7rem; opacity: 0.8; }

        /* Main Layout - Master/Detail */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
            margin-top: 60px;
        }

        /* Left Panel - Partner List */
        .list-panel {
            width: 400px;
            min-width: 350px;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            background: white;
        }
        .list-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            background: #f8fafc;
        }
        .search-box {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .search-input {
            flex: 1;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .search-input:focus { outline: none; border-color: var(--accent); }
        .filter-row {
            display: flex;
            gap: 0.5rem;
        }
        .filter-select {
            flex: 1;
            padding: 0.4rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.8rem;
            background: white;
        }
        .partner-list {
            flex: 1;
            overflow-y: auto;
        }
        .partner-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.15s;
        }
        .partner-item:hover { background: #f1f5f9; }
        .partner-item.active { background: #eff6ff; border-left: 3px solid var(--accent); }
        .partner-name { font-weight: 600; font-size: 0.95rem; color: var(--text); }
        .partner-meta { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; }
        .partner-badges { display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap; }

        /* Right Panel - Detail View */
        .detail-panel {
            flex: 1;
            overflow-y: auto;
            background: var(--bg);
        }
        .detail-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            font-size: 1.1rem;
        }
        .detail-content {
            max-width: 900px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }
        .detail-title { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .detail-subtitle { color: var(--text-muted); margin-top: 0.25rem; }
        .detail-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; flex-shrink: 0; }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 10px;
            border: 1px solid var(--border);
            margin-bottom: 1rem;
        }
        .card-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-body { padding: 1rem; }

        /* Form Elements */
        .form-row { display: flex; gap: 1rem; margin-bottom: 0.75rem; }
        .form-group { flex: 1; }
        .form-group.full { flex: 100%; }
        .form-label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.25rem; text-transform: uppercase; }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent); }
        .form-textarea { min-height: 80px; resize: vertical; }
        .form-value { font-size: 0.95rem; padding: 0.25rem 0; }

        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover { background: #f8fafc; }
        .btn-small { padding: 0.35rem 0.75rem; font-size: 0.8rem; }
        .btn-icon { padding: 0.4rem; min-width: 32px; justify-content: center; }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .badge-status-not-contacted { background: #f1f5f9; color: #64748b; }
        .badge-status-contacted { background: #dbeafe; color: #1e40af; }
        .badge-status-responded { background: #fef3c7; color: #92400e; }
        .badge-status-meeting { background: #e0e7ff; color: #4338ca; }
        .badge-status-quoted { background: #fce7f3; color: #9d174d; }
        .badge-status-won { background: #dcfce7; color: #166534; }
        .badge-status-lost { background: #fee2e2; color: #991b1b; }

        .badge-type-fabricator { background: #dbeafe; color: #1e40af; }
        .badge-type-av-integrator { background: #fae8ff; color: #86198f; }
        .badge-type-pool-landscape { background: #ccfbf1; color: #4f46e5; }
        .badge-type-hospitality { background: #fef3c7; color: #b45309; }
        .badge-type-designer { background: #fce7f3; color: #9d174d; }
        .badge-type-developer { background: #e0e7ff; color: #4f46e5; }
        .badge-type-distributor { background: #dcfce7; color: #166534; }
        .badge-type-contractor { background: #fef3c7; color: #92400e; }
        .badge-type-other { background: #f1f5f9; color: #64748b; }

        .badge-priority-high { background: #fee2e2; color: #991b1b; }
        .badge-priority-medium { background: #fef3c7; color: #92400e; }
        .badge-priority-low { background: #f1f5f9; color: #64748b; }

        /* Contacts List */
        .contact-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: #fafafa;
        }
        .contact-info { flex: 1; }
        .contact-name { font-weight: 600; font-size: 0.9rem; }
        .contact-title { font-size: 0.8rem; color: var(--text-muted); }
        .contact-details { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; }
        .contact-badges { margin-top: 0.25rem; }
        .badge-dm { background: #dcfce7; color: #166534; font-size: 0.65rem; }
        .badge-primary { background: #dbeafe; color: #1e40af; font-size: 0.65rem; }

        /* Deal Section */
        .deal-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        .deal-stat { text-align: center; padding: 1rem; background: #f8fafc; border-radius: 8px; }
        .deal-stat-value { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .deal-stat-label { font-size: 0.75rem; color: var(--text-muted); }
        .products-interested { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem; }
        .product-tag { background: var(--accent); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; }
        .product-tag.inactive { background: #e2e8f0; color: #64748b; }

        /* Activity Timeline */
        .activity-timeline { position: relative; padding-left: 1.5rem; }
        .activity-timeline::before {
            content: '';
            position: absolute;
            left: 0.5rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }
        .activity-item {
            position: relative;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
        }
        .activity-item::before {
            content: '';
            position: absolute;
            left: -1.25rem;
            top: 1rem;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent);
            border: 2px solid white;
        }
        .activity-item.type-call::before { background: #10b981; }
        .activity-item.type-email_sent::before { background: #2563eb; }
        .activity-item.type-email_received::before { background: #8b5cf6; }
        .activity-item.type-meeting::before { background: #f59e0b; }
        .activity-item.type-demo::before { background: #ec4899; }
        .activity-item.type-quote_sent::before { background: #14b8a6; }
        .activity-item.type-site_visit::before { background: #f97316; }
        .activity-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; }
        .activity-type { font-weight: 600; font-size: 0.85rem; }
        .activity-date { font-size: 0.75rem; color: var(--text-muted); }
        .activity-desc { font-size: 0.85rem; color: var(--text); }

        /* Add Activity Form */
        .add-activity-form {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: 8px;
        }
        .add-activity-form select { width: 140px; }
        .add-activity-form input { flex: 1; }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .modal-title { font-size: 1.1rem; font-weight: 600; }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid var(--border);
            margin-bottom: 1rem;
        }
        .tab {
            padding: 0.75rem 1.25rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-muted);
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        .tab:hover { color: var(--text); }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* New Partner Button */
        .new-partner-btn {
            width: 100%;
            padding: 0.75rem;
            margin: 1rem 1rem 0 1rem;
            width: calc(100% - 2rem);
        }

        /* Contact Type Badges */
        .badge-contact-manufacturing { background: #fef3c7; color: #92400e; }
        .badge-contact-partner { background: #dbeafe; color: #1e40af; }
        .badge-contact-commercial { background: #e0e7ff; color: #4f46e5; }
        .badge-contact-retail { background: #dcfce7; color: #166534; }

        /* Responsive */
        @media (max-width: 900px) {
            .list-panel { width: 100%; position: absolute; z-index: 50; height: 100%; }
            .detail-panel { display: none; }
            .detail-panel.active { display: block; position: absolute; left: 0; right: 0; z-index: 60; }
            .back-btn { display: block !important; }
        }
        .back-btn { display: none; }
        /* User badge in header */
        .user-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.15);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        .user-badge .user-avatar {
            width: 28px;
            height: 28px;
            background: rgba(255,255,255,0.25);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 11px;
        }
        .user-badge .user-info {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }
        .user-badge .user-name {
            font-weight: 500;
        }
        .user-badge .user-territory {
            font-size: 0.7rem;
            opacity: 0.8;
        }
        .user-badge .logout-btn {
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            padding: 4px;
            margin-left: 4px;
        }
        .user-badge .logout-btn:hover {
            color: white;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="auth-guard.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>Apex CRM</h1>
        <div class="header-stats">
            <div class="stat"><div class="stat-value" id="totalPartners">0</div><div class="stat-label">Total</div></div>
            <div class="stat"><div class="stat-value" id="activeDeals">0</div><div class="stat-label">Active</div></div>
            <div class="stat"><div class="stat-value" id="pipelineValue">0</div><div class="stat-label">Pipeline</div></div>
            <div class="stat"><div class="stat-value" id="followupsToday">0</div><div class="stat-label">Follow-ups</div></div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Panel - Partner List -->
        <div class="list-panel">
            <div class="list-header">
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search partners..." oninput="renderList()">
                    <button class="btn btn-primary btn-icon" onclick="showNewPartnerModal()">+</button>
                </div>
                <div class="filter-row">
                    <select class="filter-select" id="contactTypeFilter" onchange="setContactTypeFilter(this.value)">
                        <option value="">All Contacts</option>
                        <option value="manufacturing">Manufacturing</option>
                        <option value="partner">Partners</option>
                        <option value="commercial">Commercial</option>
                        <option value="retail">Retail</option>
                    </select>
                    <select class="filter-select" id="typeFilter" onchange="renderList()">
                        <option value="">All Types</option>
                        <option value="Fabricator">Fabricator</option>
                        <option value="AV Integrator">AV Integrator</option>
                        <option value="Pool/Landscape">Pool/Landscape</option>
                        <option value="Hospitality">Hospitality</option>
                        <option value="Designer">Designer</option>
                        <option value="Developer">Developer</option>
                        <option value="Distributor">Distributor</option>
                        <option value="Contractor">Contractor</option>
                    </select>
                    <select class="filter-select" id="statusFilter" onchange="renderList()">
                        <option value="live" selected>Live Contacts</option>
                        <option value="">All Status</option>
                        <option value="Not Contacted">Not Contacted</option>
                        <option value="Contacted">Contacted</option>
                        <option value="Responded">Responded</option>
                        <option value="Meeting">Meeting</option>
                        <option value="Quoted">Quoted</option>
                        <option value="Won">Won</option>
                        <option value="Lost">Lost</option>
                    </select>
                    <select class="filter-select" id="regionFilter" onchange="renderList()">
                        <option value="">All Regions</option>
                        <option value="UAE">UAE</option>
                        <option value="USA">USA</option>
                        <option value="GCC">GCC</option>
                        <option value="China">China</option>
                        <option value="Europe">Europe</option>
                    </select>
                </div>
            </div>
            <div class="partner-list" id="partnerList"></div>
        </div>

        <!-- Right Panel - Detail View -->
        <div class="detail-panel" id="detailPanel">
            <div class="detail-empty" id="detailEmpty">
                Select a partner to view details
            </div>
            <div class="detail-content" id="detailContent" style="display: none;"></div>
        </div>
    </div>

    <!-- New Partner Modal -->
    <div class="modal-overlay" id="newPartnerModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Add New Partner</span>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="newPartnerForm" onsubmit="createPartner(event)">
                <div class="form-group" style="margin-bottom: 0.75rem;">
                    <label class="form-label">Company Name *</label>
                    <input type="text" class="form-input" id="newCompanyName" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Contact Type *</label>
                        <select class="form-select" id="newContactType" required>
                            <option value="manufacturing">Manufacturing</option>
                            <option value="partner">Partner</option>
                            <option value="commercial">Commercial</option>
                            <option value="retail">Retail</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Region *</label>
                        <select class="form-select" id="newRegion" required>
                            <option value="UAE">UAE</option>
                            <option value="GCC">GCC</option>
                            <option value="China">China</option>
                            <option value="Europe">Europe</option>
                            <option value="USA">USA</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 0.75rem;">
                    <label class="form-label">Business Type *</label>
                    <select class="form-select" id="newPartnerType" required>
                        <option value="Fabricator">Fabricator</option>
                        <option value="AV Integrator">AV Integrator</option>
                        <option value="Pool/Landscape">Pool/Landscape</option>
                        <option value="Hospitality">Hospitality</option>
                        <option value="Designer">Designer</option>
                        <option value="Developer">Developer</option>
                        <option value="Distributor">Distributor</option>
                        <option value="Contractor">Contractor</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Contact Name</label>
                        <input type="text" class="form-input" id="newContactName">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="newEmail">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="text" class="form-input" id="newPhone">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Website</label>
                        <input type="url" class="form-input" id="newWebsite" placeholder="https://...">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 0.75rem;">
                    <label class="form-label">Lead Source</label>
                    <select class="form-select" id="newLeadSource">
                        <option value="cold_outreach">Cold Outreach</option>
                        <option value="linkedin">LinkedIn</option>
                        <option value="referral">Referral</option>
                        <option value="website">Website</option>
                        <option value="trade_show">Trade Show</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="newNotes" rows="2"></textarea>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button type="submit" class="btn btn-primary">Create Partner</button>
                    <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Contact Modal -->
    <div class="modal-overlay" id="addContactModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Add Contact</span>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="addContactForm" onsubmit="addContact(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-input" id="contactName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Job Title</label>
                        <input type="text" class="form-input" id="contactTitle" placeholder="e.g. Sales Manager">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="contactEmail">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="text" class="form-input" id="contactPhone">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label"><input type="checkbox" id="contactIsPrimary"> Primary Contact</label>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><input type="checkbox" id="contactIsDecisionMaker"> Decision Maker</label>
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button type="submit" class="btn btn-primary">Add Contact</button>
                    <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============ SUPABASE CONFIGURATION ============
        const SUPABASE_URL = 'https://krhyzbmewvfkacoujimm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtyaHl6Ym1ld3Zma2Fjb3VqaW1tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczMjkyNTksImV4cCI6MjA4MjkwNTI1OX0.YygJElB9Vaet1bsz_4U8ePKidrleMnRzkoMCiy6oOUY';

        let supabaseClient = null;
        let useSupabase = true; // Always use Supabase

        async function initSupabase() {
            try {
                // Use the client from auth-guard if available (authenticated)
                if (window.supabaseClient) {
                    supabaseClient = window.supabaseClient;
                    console.log('Using authenticated Supabase client');
                } else {
                    // Fallback to anon client (will be blocked by RLS when enabled)
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log('Using anonymous Supabase client');
                }
                useSupabase = true;
                updateConnectionBadge(true);

                // Show user badge if authenticated
                if (window.currentUser) {
                    await showUserBadge();
                }
            } catch (e) {
                console.error('Supabase connection failed:', e);
                useSupabase = false;
                updateConnectionBadge(false);
            }
        }

        async function showUserBadge() {
            const user = window.currentUser;
            if (!user) return;

            // Get user's territory
            let territory = 'Unknown';
            try {
                const { data: territories } = await supabaseClient
                    .from('user_territories')
                    .select('territory')
                    .eq('user_id', user.id);

                if (territories && territories.length > 0) {
                    territory = territories.map(t => t.territory).join(', ');
                    if (territory === 'ALL') territory = 'All Regions';
                }
            } catch (e) {
                console.log('Could not fetch territory:', e);
            }

            // Get user name
            const name = user.user_metadata?.full_name || user.email?.split('@')[0] || 'User';
            const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

            // Create badge
            const badge = document.createElement('div');
            badge.className = 'user-badge';
            badge.innerHTML = `
                <div class="user-avatar">${initials}</div>
                <div class="user-info">
                    <span class="user-name">${name}</span>
                    <span class="user-territory">${territory}</span>
                </div>
                <button class="logout-btn" onclick="signOut()" title="Sign out">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                </button>
            `;

            // Add to header
            document.querySelector('.header').appendChild(badge);
        }

        async function signOut() {
            await supabaseClient.auth.signOut();
            window.location.href = 'login.html';
        }

        function updateConnectionBadge(connected) {
            // Badge hidden - not needed for normal use
        }

        // ============ DATA LAYER ============
        let partners = [];
        let selectedPartnerId = null;
        let contactTypeFilter = ''; // '', 'manufacturing', 'partner', 'commercial', 'retail'

        // Activity type labels
        const activityTypes = {
            'note': 'Note',
            'call': 'Call',
            'email_sent': 'Email Sent',
            'email_received': 'Email Received',
            'meeting': 'Meeting',
            'demo': 'Demo',
            'quote_sent': 'Quote Sent',
            'site_visit': 'Site Visit'
        };

        // Initial data - migrated from old format
        const initialPartners = [
            // ============ UAE MANUFACTURERS ============
            {
                id: 1,
                companyName: 'Al Shurooq',
                contactType: 'manufacturing',
                partnerType: 'Fabricator',
                region: 'UAE',
                website: 'https://alshurooq.ae',
                linkedInUrl: '',
                address: 'Dubai, UAE',
                leadSource: 'cold_outreach',
                status: 'Contacted',
                priority: 'High',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 40,
                lostReason: '',
                followupDate: '2026-01-16',
                notes: 'In discussion - requested trade license, we said prototype first as individual. Active conversation with Danica.',
                contacts: [
                    { id: 1, name: 'Danica Sison', title: 'Sales', email: 'support1@alshurooq.ae', phone: '+971 4 42 55988', isPrimary: true, isDecisionMaker: false }
                ],
                activities: [
                    { id: 1, type: 'email_sent', description: 'Initial RFQ sent', timestamp: '2025-12-23T23:13:00Z' },
                    { id: 2, type: 'email_received', description: 'Reply from Danica - interested, reviewing', timestamp: '2025-12-24T17:00:00Z' },
                    { id: 3, type: 'email_sent', description: 'Follow-up reply', timestamp: '2025-12-24T23:16:00Z' },
                    { id: 4, type: 'email_received', description: 'Danica requested trade license', timestamp: '2025-12-26T11:37:00Z' },
                    { id: 5, type: 'email_sent', description: 'Replied - proceeding as individual for prototype', timestamp: '2025-12-26T14:29:00Z' },
                    { id: 6, type: 'email_received', description: 'Acknowledgement from Danica', timestamp: '2025-12-26T14:44:00Z' },
                    { id: 7, type: 'email_received', description: 'Follow-up from Danica', timestamp: '2025-12-31T10:29:00Z' },
                    { id: 8, type: 'email_sent', description: 'Reply to Danica', timestamp: '2025-12-31T14:42:00Z' },
                    { id: 9, type: 'email_received', description: 'Reply from Danica', timestamp: '2026-01-05T09:43:00Z' },
                    { id: 10, type: 'email_sent', description: 'Follow-up sent', timestamp: '2026-01-05T09:46:00Z' },
                    { id: 11, type: 'email_received', description: 'Reply from Danica', timestamp: '2026-01-06T14:32:00Z' },
                    { id: 12, type: 'email_received', description: 'Follow-up from Danica', timestamp: '2026-01-09T08:33:00Z' },
                    { id: 13, type: 'email_sent', description: 'Reply sent', timestamp: '2026-01-09T09:11:00Z' }
                ],
                createdAt: '2025-12-23T23:13:00Z',
                lastContact: '2026-01-09T09:11:00Z'
            },
            {
                id: 2,
                companyName: 'Eurotech Metal Industries',
                contactType: 'manufacturing',
                partnerType: 'Fabricator',
                region: 'UAE',
                website: 'https://eurotech-metal.com',
                linkedInUrl: '',
                address: 'JAFZA North, St.N306, Plot MO0625, PO Box 61196, Dubai, UAE',
                leadSource: 'cold_outreach',
                status: 'Proposal',
                priority: 'High',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 70,
                lostReason: '',
                followupDate: '2026-01-13',
                notes: 'TOP PRIORITY - Factory visit 8 Jan was excellent. 2000hr salt spray, ISO 9001/14001/45001 certified. Guillaume quote due Monday 13 Jan.',
                contacts: [
                    { id: 1, name: 'Guillaume Caupert', title: 'Head of Sales and Marketing', email: 'guillaume.caupert@eurotech-metal.com', phone: '+971 56 801 4290', isPrimary: true, isDecisionMaker: true },
                    { id: 2, name: 'Walid Ragab', title: 'Sales Manager', email: 'walid.mohamed@eurotech-metal.com', phone: '', isPrimary: false, isDecisionMaker: false }
                ],
                activities: [
                    { id: 1, type: 'email_sent', description: 'Initial RFQ sent to general@eurotech-metal.com', timestamp: '2025-12-23T23:13:00Z' },
                    { id: 2, type: 'email_received', description: 'Reply from Walid Ragab - interested in project', timestamp: '2025-12-30T09:11:00Z' },
                    { id: 3, type: 'email_sent', description: 'Follow-up reply to Walid', timestamp: '2025-12-31T14:13:00Z' },
                    { id: 4, type: 'email_sent', description: 'Follow-up to Walid', timestamp: '2026-01-04T14:33:00Z' },
                    { id: 5, type: 'meeting', description: 'Meeting invite received from Walid - factory visit scheduled for 8 Jan', timestamp: '2026-01-05T07:49:00Z' },
                    { id: 6, type: 'email_received', description: 'FW: Richard documents from Walid', timestamp: '2026-01-05T09:43:00Z' },
                    { id: 7, type: 'email_received', description: 'Guillaume confirming factory visit', timestamp: '2026-01-08T08:40:00Z' },
                    { id: 8, type: 'site_visit', description: 'Factory tour at JAFZA. Very impressed - 2000hr salt spray test, ISO 9001/14001/45001 certified. Met Guillaume (Head of Sales) and team.', timestamp: '2026-01-08T13:00:00Z' },
                    { id: 9, type: 'email_sent', description: 'Sent ATE-75 Design Pack (14MB PDF) to Guillaume after visit', timestamp: '2026-01-08T16:58:00Z' },
                    { id: 10, type: 'email_received', description: 'Guillaume confirmed working on technical review, quote by Monday', timestamp: '2026-01-09T16:45:00Z' },
                    { id: 11, type: 'email_sent', description: 'Thank you reply - looking forward to quote', timestamp: '2026-01-09T21:48:00Z' }
                ],
                createdAt: '2025-12-23T23:13:00Z',
                lastContact: '2026-01-09T21:48:00Z'
            },
            {
                id: 3,
                companyName: 'Al Amazon Industries',
                contactType: 'manufacturing',
                partnerType: 'Fabricator',
                region: 'UAE',
                website: 'https://www.alamazonuae.com',
                linkedInUrl: '',
                address: 'Sharjah, UAE',
                leadSource: 'cold_outreach',
                status: 'Not Contacted',
                priority: 'High',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 30,
                lostReason: '',
                followupDate: '2025-01-02',
                notes: 'HIGH FIT - Already makes aluminum enclosures & electrical cabinets. Has own powder coating plant. Custom specs to DEWA/ADDC standards.',
                contacts: [
                    { id: 1, name: '', title: '', email: 'alamazonuae@gmail.com', phone: '+971 6 535 5667', isPrimary: true, isDecisionMaker: false }
                ],
                activities: [
                    { id: 1, type: 'email_sent', description: 'RFQ sent via email', timestamp: '2025-12-24T08:00:00Z' }
                ],
                createdAt: '2025-12-24T08:00:00Z',
                lastContact: '2025-12-24T08:00:00Z'
            },
            {
                id: 6,
                companyName: 'EmirFab',
                contactType: 'manufacturing',
                partnerType: 'Fabricator',
                region: 'UAE',
                website: '',
                linkedInUrl: '',
                address: 'UAE',
                leadSource: 'cold_outreach',
                status: 'Not Contacted',
                priority: 'Medium',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 20,
                lostReason: '',
                followupDate: '2025-01-05',
                notes: 'UAE fabricator - RFQ sent Dec 24',
                contacts: [],
                activities: [
                    { id: 1, type: 'email_sent', description: 'RFQ sent via email', timestamp: '2025-12-24T08:00:00Z' }
                ],
                createdAt: '2025-12-24T08:00:00Z',
                lastContact: '2025-12-24T08:00:00Z'
            },
            {
                id: 7,
                companyName: 'Rainbow',
                contactType: 'manufacturing',
                partnerType: 'Fabricator',
                region: 'UAE',
                website: '',
                linkedInUrl: '',
                address: 'UAE',
                leadSource: 'cold_outreach',
                status: 'Not Contacted',
                priority: 'Medium',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 20,
                lostReason: '',
                followupDate: '2025-01-05',
                notes: 'UAE fabricator - RFQ sent Dec 24',
                contacts: [],
                activities: [
                    { id: 1, type: 'email_sent', description: 'RFQ sent via email', timestamp: '2025-12-24T08:00:00Z' }
                ],
                createdAt: '2025-12-24T08:00:00Z',
                lastContact: '2025-12-24T08:00:00Z'
            },
            // ============ SAUDI MANUFACTURERS ============
            {
                id: 5,
                companyName: 'Flezco',
                contactType: 'manufacturing',
                partnerType: 'Fabricator',
                region: 'GCC',
                website: 'https://www.flezco.com',
                linkedInUrl: '',
                address: 'Jeddah, Saudi Arabia',
                leadSource: 'cold_outreach',
                status: 'Not Contacted',
                priority: 'High',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 25,
                lostReason: '',
                followupDate: '2025-01-02',
                notes: 'HIGH FIT - Saudi Jeddah + nationwide. Sheet metal for enclosures, machinery panels.',
                contacts: [
                    { id: 1, name: '', title: '', email: 'hello@flezco.com', phone: '+966 50 830 4644', isPrimary: true, isDecisionMaker: false }
                ],
                activities: [
                    { id: 1, type: 'email_sent', description: 'RFQ sent via email', timestamp: '2025-12-24T08:00:00Z' }
                ],
                createdAt: '2025-12-24T08:00:00Z',
                lastContact: '2025-12-24T08:00:00Z'
            },
            {
                id: 8,
                companyName: 'SMF',
                contactType: 'manufacturing',
                partnerType: 'Fabricator',
                region: 'GCC',
                website: '',
                linkedInUrl: '',
                address: 'Saudi Arabia',
                leadSource: 'cold_outreach',
                status: 'Not Contacted',
                priority: 'Medium',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 20,
                lostReason: '',
                followupDate: '2025-01-05',
                notes: 'Saudi fabricator - RFQ sent Dec 24',
                contacts: [],
                activities: [
                    { id: 1, type: 'email_sent', description: 'RFQ sent via email', timestamp: '2025-12-24T08:00:00Z' }
                ],
                createdAt: '2025-12-24T08:00:00Z',
                lastContact: '2025-12-24T08:00:00Z'
            },
            {
                id: 9,
                companyName: 'Lucky',
                contactType: 'manufacturing',
                partnerType: 'Fabricator',
                region: 'GCC',
                website: '',
                linkedInUrl: '',
                address: 'Saudi Arabia',
                leadSource: 'cold_outreach',
                status: 'Not Contacted',
                priority: 'Medium',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 20,
                lostReason: '',
                followupDate: '2025-01-05',
                notes: 'Saudi fabricator - RFQ sent Dec 24',
                contacts: [],
                activities: [
                    { id: 1, type: 'email_sent', description: 'RFQ sent via email', timestamp: '2025-12-24T08:00:00Z' }
                ],
                createdAt: '2025-12-24T08:00:00Z',
                lastContact: '2025-12-24T08:00:00Z'
            },
            {
                id: 10,
                companyName: 'Prisma',
                contactType: 'manufacturing',
                partnerType: 'Fabricator',
                region: 'GCC',
                website: '',
                linkedInUrl: '',
                address: 'Saudi Arabia',
                leadSource: 'cold_outreach',
                status: 'Not Contacted',
                priority: 'Medium',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 20,
                lostReason: '',
                followupDate: '2025-01-05',
                notes: 'Saudi fabricator - RFQ sent Dec 24',
                contacts: [],
                activities: [
                    { id: 1, type: 'email_sent', description: 'RFQ sent via email', timestamp: '2025-12-24T08:00:00Z' }
                ],
                createdAt: '2025-12-24T08:00:00Z',
                lastContact: '2025-12-24T08:00:00Z'
            },
            // ============ CHINA MANUFACTURERS ============
            {
                id: 4,
                companyName: 'KDM Steel',
                contactType: 'manufacturing',
                partnerType: 'Fabricator',
                region: 'China',
                website: 'https://www.kdmsteel.com',
                linkedInUrl: '',
                address: 'Wuxi, Jiangsu, China',
                leadSource: 'cold_outreach',
                status: 'Responded',
                priority: 'High',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 50,
                lostReason: '',
                followupDate: '2025-01-03',
                notes: 'TOP PICK - Pure OEM fabricator. 10+ years, ISO 9001, makes outdoor enclosures to spec. Initial contact made with Jason.',
                contacts: [
                    { id: 1, name: 'Jason', title: 'Sales', email: 'sales@kdmsteel.com', phone: '+86-13175970882', isPrimary: true, isDecisionMaker: false }
                ],
                activities: [
                    { id: 1, type: 'email_sent', description: 'Initial RFQ sent for custom electronics enclosure', timestamp: '2025-12-28T09:39:00Z' },
                    { id: 2, type: 'email_received', description: 'Reply from Jason - interested in project', timestamp: '2025-12-29T16:55:00Z' },
                    { id: 3, type: 'email_sent', description: 'Follow-up reply to Jason', timestamp: '2025-12-31T14:43:00Z' }
                ],
                createdAt: '2025-12-28T09:39:00Z',
                lastContact: '2025-12-31T14:43:00Z'
            },
            {
                id: 11,
                companyName: 'Hofengfab',
                contactType: 'manufacturing',
                partnerType: 'Fabricator',
                region: 'China',
                website: 'https://hofengfab.com',
                linkedInUrl: '',
                address: 'Shenzhen, China',
                leadSource: 'cold_outreach',
                status: 'Not Contacted',
                priority: 'Medium',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 30,
                lostReason: '',
                followupDate: '',
                notes: 'Die-cast aluminum specialist, IP66/67, exports to Middle East. Pure OEM fabricator - SAFE to approach.',
                contacts: [
                    { id: 1, name: 'Vivian', title: 'Sales', email: 'vivian@hofengfab.com', phone: '', isPrimary: true, isDecisionMaker: false }
                ],
                activities: [],
                createdAt: '2025-12-28T00:00:00Z',
                lastContact: null
            },
            {
                id: 12,
                companyName: 'SKYT',
                contactType: 'manufacturing',
                partnerType: 'Fabricator',
                region: 'China',
                website: 'https://www.hbskyt.com',
                linkedInUrl: '',
                address: 'Hebei, China',
                leadSource: 'cold_outreach',
                status: 'Not Contacted',
                priority: 'Medium',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 25,
                lostReason: '',
                followupDate: '',
                notes: 'Outdoor cabinets, telecom enclosures, OEM focus. Pure fabricator - SAFE to approach.',
                contacts: [
                    { id: 1, name: 'Wendy', title: 'Sales', email: 'Wendy@hbskyt.com', phone: '+86-15832266315', isPrimary: true, isDecisionMaker: false }
                ],
                activities: [],
                createdAt: '2025-12-28T00:00:00Z',
                lastContact: null
            },
            {
                id: 13,
                companyName: 'MaidaTech',
                contactType: 'manufacturing',
                partnerType: 'Fabricator',
                region: 'China',
                website: 'https://maidatechenclosure.com',
                linkedInUrl: '',
                address: 'Shenzhen, China',
                leadSource: 'cold_outreach',
                status: 'Not Contacted',
                priority: 'Medium',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 25,
                lostReason: '',
                followupDate: '',
                notes: '9+ years, custom aluminum enclosures, OEM/ODM. Pure fabricator - SAFE to approach.',
                contacts: [],
                activities: [],
                createdAt: '2025-12-28T00:00:00Z',
                lastContact: null
            },
            {
                id: 14,
                companyName: 'Hongfashunda',
                contactType: 'manufacturing',
                partnerType: 'Fabricator',
                region: 'China',
                website: 'https://enclosure-box-mould.com',
                linkedInUrl: '',
                address: 'Shenzhen, China',
                leadSource: 'cold_outreach',
                status: 'Not Contacted',
                priority: 'Medium',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 25,
                lostReason: '',
                followupDate: '',
                notes: 'ISO 9001, 2pc MOQ, aluminum extrusion. Pure fabricator - SAFE to approach.',
                contacts: [],
                activities: [],
                createdAt: '2025-12-28T00:00:00Z',
                lastContact: null
            },
            {
                id: 15,
                companyName: 'SZOMK',
                contactType: 'manufacturing',
                partnerType: 'Fabricator',
                region: 'China',
                website: 'https://chinaenclosure.com',
                linkedInUrl: '',
                address: 'Shenzhen, China',
                leadSource: 'cold_outreach',
                status: 'Not Contacted',
                priority: 'Medium',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 25,
                lostReason: '',
                followupDate: '',
                notes: '1000+ molds, cutouts/laser, low MOQ. Pure fabricator - SAFE to approach.',
                contacts: [],
                activities: [],
                createdAt: '2025-12-28T00:00:00Z',
                lastContact: null
            },
            // Sales Partners
            {
                id: 101,
                companyName: 'Pulse Cinemas Middle East',
                contactType: 'partner',
                partnerType: 'AV Integrator',
                region: 'UAE',
                website: 'https://www.pulsecinemas.com',
                linkedInUrl: '',
                address: 'Dubai, UAE',
                leadSource: 'cold_outreach',
                status: 'Not Contacted',
                priority: 'High',
                dealValue: 50000,
                productsInterested: ['75"', '65"'],
                expectedCloseDate: '',
                winProbability: 0,
                lostReason: '',
                followupDate: '',
                notes: 'Luxury home cinema installation. Perfect partner for high-end residential market.',
                contacts: [],
                activities: [],
                createdAt: '2025-12-31T21:00:00Z',
                lastContact: null
            },
            {
                id: 102,
                companyName: 'Almoe AV Systems',
                contactType: 'partner',
                partnerType: 'AV Integrator',
                region: 'UAE',
                website: 'https://www.almoe.com',
                linkedInUrl: '',
                address: 'Dubai, UAE',
                leadSource: 'cold_outreach',
                status: 'Not Contacted',
                priority: 'High',
                dealValue: 75000,
                productsInterested: ['75"', '65"', '55"'],
                expectedCloseDate: '',
                winProbability: 0,
                lostReason: '',
                followupDate: '',
                notes: 'AV integration, smart homes. Major player in UAE market.',
                contacts: [
                    { id: 1, name: '', title: '', email: 'info@almoe.com', phone: '+971 4 339 4455', isPrimary: true, isDecisionMaker: false }
                ],
                activities: [],
                createdAt: '2025-12-31T21:00:00Z',
                lastContact: null
            },
            {
                id: 103,
                companyName: 'Emaar Properties',
                contactType: 'commercial',
                partnerType: 'Developer',
                region: 'UAE',
                website: 'https://www.emaar.com',
                linkedInUrl: 'https://www.linkedin.com/company/emaar',
                address: 'Dubai, UAE',
                leadSource: 'cold_outreach',
                status: 'Not Contacted',
                priority: 'High',
                dealValue: 500000,
                productsInterested: ['75"', '65"'],
                expectedCloseDate: '',
                winProbability: 0,
                lostReason: '',
                followupDate: '',
                notes: 'Largest developer in UAE. Target for bulk orders in new developments with outdoor entertainment areas.',
                contacts: [],
                activities: [],
                createdAt: '2025-12-31T21:00:00Z',
                lastContact: null
            },
            {
                id: 104,
                companyName: 'Bishop Design',
                contactType: 'partner',
                partnerType: 'Designer',
                region: 'UAE',
                website: 'https://www.bishopdesign.com',
                linkedInUrl: '',
                address: 'Dubai, UAE',
                leadSource: 'cold_outreach',
                status: 'Not Contacted',
                priority: 'Medium',
                dealValue: 25000,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 0,
                lostReason: '',
                followupDate: '',
                notes: 'Hospitality-focused interior design. Many hotel/restaurant projects.',
                contacts: [],
                activities: [],
                createdAt: '2025-12-31T21:00:00Z',
                lastContact: null
            },
            {
                id: 105,
                companyName: 'Desert Dreams Landscaping',
                contactType: 'contractor',
                partnerType: 'Pool/Landscape',
                region: 'UAE',
                website: '',
                linkedInUrl: '',
                address: 'Dubai, UAE',
                leadSource: 'cold_outreach',
                status: 'Not Contacted',
                priority: 'Medium',
                dealValue: 35000,
                productsInterested: ['75"', '65"'],
                expectedCloseDate: '',
                winProbability: 0,
                lostReason: '',
                followupDate: '',
                notes: 'Pool and outdoor living specialists. Good referral partner for residential installations.',
                contacts: [],
                activities: [],
                createdAt: '2025-12-31T21:00:00Z',
                lastContact: null
            },
            // ============ STRATEGIC PARTNERS ============
            {
                id: 150,
                companyName: 'Scott - US/UK/EU Sales Partner',
                contactType: 'partner',
                partnerType: 'Sales Partner',
                region: 'USA',
                website: '',
                linkedInUrl: '',
                address: 'UK',
                leadSource: 'referral',
                status: 'Meeting',
                priority: 'High',
                dealValue: 0,
                productsInterested: ['75"', '65"'],
                expectedCloseDate: '',
                winProbability: 80,
                lostReason: '',
                followupDate: '',
                notes: 'Potential US/UK/EU sales partner. Equity structure: Richard 25% / Tom 25% / Scott 50% for Western markets. CC on all US manufacturer outreach.',
                contacts: [
                    { id: 1, name: 'Scott', title: 'Partner', email: 'Scott@b-stemed.com', phone: '', isPrimary: true, isDecisionMaker: true }
                ],
                activities: [],
                createdAt: '2026-01-09T12:00:00Z',
                lastContact: null
            },
            // ============ US MANUFACTURERS (Tier 1) ============
            {
                id: 200,
                companyName: 'Bull Metal Products',
                contactType: 'manufacturing',
                partnerType: 'Fabricator',
                region: 'USA',
                website: 'https://bullmetal.com',
                linkedInUrl: 'https://www.linkedin.com/company/bull-metal-products-inc-',
                address: '191 Saybrook Road, PO Box 738, Middletown, CT 06457',
                leadSource: 'cold_outreach',
                status: 'Contacted',
                priority: 'High',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 30,
                lostReason: '',
                followupDate: '2026-01-16',
                notes: 'TIER 1 - ISO 9001:2015. 65+ years experience (since 1954). 40,000+ sq ft facility. Second generation family business. Weatherproof aluminum enclosures, electrical enclosures, NEMA cabinets.',
                contacts: [
                    { id: 1, name: 'Steve Bull', title: 'President', email: 'sales@bullmetal.com', phone: '(860) 346-9691', isPrimary: true, isDecisionMaker: true }
                ],
                activities: [
                    { id: 1, type: 'email_sent', description: 'Initial RFQ sent (US manufacturing partner outreach)', timestamp: '2026-01-09T13:50:00Z' }
                ],
                createdAt: '2026-01-09T13:50:00Z',
                lastContact: '2026-01-09T13:50:00Z'
            },
            {
                id: 201,
                companyName: 'Accurate Metal Fabricating',
                contactType: 'manufacturing',
                partnerType: 'Fabricator',
                region: 'USA',
                website: 'https://www.accuratemetalfab.com',
                linkedInUrl: 'https://www.linkedin.com/company/accurate-metal-fabricating',
                address: '4620 W. 19th Street, Cicero, IL 60804',
                leadSource: 'cold_outreach',
                status: 'Proposal',
                priority: 'High',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 50,
                lostReason: '',
                followupDate: '2026-01-16',
                notes: 'HOT LEAD - Ted replied same day. Can do watertight aluminum, willing to sign NDA, 4-6 week sample lead time. Sent NDA + Design Pack 9 Jan.',
                contacts: [
                    { id: 1, name: 'Ted Zaplatosch', title: 'Sales Representative', email: 'tzaplatosch@accuratemetalfab.com', phone: '773-432-4720', isPrimary: true, isDecisionMaker: false },
                    { id: 2, name: 'Daniel Cohen', title: 'Managing Director', email: 'sales@accuratemetalfab.com', phone: '773-432-4720', isPrimary: false, isDecisionMaker: true },
                    { id: 3, name: 'David Kamins', title: 'Sales Representative', email: 'sales@accuratemetalfab.com', phone: '773-432-4720', isPrimary: false, isDecisionMaker: false }
                ],
                activities: [
                    { id: 1, type: 'email_sent', description: 'Initial RFQ sent (US manufacturing partner outreach)', timestamp: '2026-01-09T13:51:00Z' },
                    { id: 2, type: 'email_received', description: 'Ted replied - can do watertight aluminum, willing to sign NDA, needs DXF/PDF, 4-6 week sample lead time', timestamp: '2026-01-09T20:17:00Z' },
                    { id: 3, type: 'email_sent', description: 'Sent NDA + ATE-75 Design Pack. Requested quotes for 50/100/150 + prototype. Mentioned CAD coming from Dubai.', timestamp: '2026-01-09T21:47:00Z' }
                ],
                createdAt: '2026-01-09T13:51:00Z',
                lastContact: '2026-01-09T21:47:00Z'
            },
            {
                id: 202,
                companyName: 'Bison ProFab',
                contactType: 'manufacturing',
                partnerType: 'Fabricator',
                region: 'USA',
                website: 'https://www.bisonprofab.com',
                linkedInUrl: '',
                address: '12519 Wanda Ln, Magnolia, TX 77354',
                leadSource: 'cold_outreach',
                status: 'Contacted',
                priority: 'High',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 30,
                lostReason: '',
                followupDate: '2026-01-16',
                notes: 'TIER 1 - UL Approved, Intertek IP66 CERTIFIED. NEMA 4X aluminum, saltwater corrosion resistant. Already does IP-rated enclosures - strong fit.',
                contacts: [
                    { id: 1, name: 'Joshua Henderson', title: 'Sales Director', email: 'jhenderson@bisonprofab.com', phone: '(281) 356-0026', isPrimary: true, isDecisionMaker: true },
                    { id: 2, name: 'Roman Williams', title: 'Sales Director', email: 'rwilliams@bisonprofab.com', phone: '(888) 623-6042', isPrimary: false, isDecisionMaker: true },
                    { id: 3, name: 'Ricardo Amaral', title: 'COO', email: 'ramaral@bisonprofab.com', phone: '(281) 356-0026', isPrimary: false, isDecisionMaker: true }
                ],
                activities: [
                    { id: 1, type: 'email_sent', description: 'Initial RFQ sent (US manufacturing partner outreach)', timestamp: '2026-01-09T13:54:00Z' }
                ],
                createdAt: '2026-01-09T13:54:00Z',
                lastContact: '2026-01-09T13:54:00Z'
            },
            {
                id: 203,
                companyName: 'DDB Unlimited',
                contactType: 'manufacturing',
                partnerType: 'Fabricator',
                region: 'USA',
                website: 'https://www.ddbunlimited.com',
                linkedInUrl: '',
                address: '2301 US-77, Pauls Valley, OK 73075',
                leadSource: 'cold_outreach',
                status: 'Contacted',
                priority: 'High',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 30,
                lostReason: '',
                followupDate: '2026-01-16',
                notes: 'TIER 1 - ISO 9001. Since 1996. NEMA 3R to 4X cabinets. 15-YEAR WARRANTY. Family business (Mahorney family). Telecom, aerospace, green energy, oil/gas sectors.',
                contacts: [
                    { id: 1, name: 'Dustin Mahorney', title: 'President', email: 'dustin@ddbunlimited.com', phone: '(800) 753-8459', isPrimary: true, isDecisionMaker: true },
                    { id: 2, name: 'Bryan Campbell', title: 'Sales Manager', email: '', phone: '(800) 753-8459 x2867', isPrimary: false, isDecisionMaker: false },
                    { id: 3, name: 'Mike Mahorney', title: 'Corp. General Manager', email: 'mike@ddbunlimited.com', phone: '(800) 753-8459 x2818', isPrimary: false, isDecisionMaker: true }
                ],
                activities: [
                    { id: 1, type: 'email_sent', description: 'Initial RFQ sent (US manufacturing partner outreach)', timestamp: '2026-01-09T13:48:00Z' }
                ],
                createdAt: '2026-01-09T13:48:00Z',
                lastContact: '2026-01-09T13:48:00Z'
            },
            // ============ US MANUFACTURERS (Tier 2) ============
            {
                id: 204,
                companyName: 'APX Enclosures',
                contactType: 'manufacturing',
                partnerType: 'Fabricator',
                region: 'USA',
                website: 'https://apx-enclosures.com',
                linkedInUrl: '',
                address: 'USA',
                leadSource: 'cold_outreach',
                status: 'Not Contacted',
                priority: 'Medium',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 0,
                lostReason: '',
                followupDate: '',
                notes: 'TIER 2 - Since 2001. NEMA 3R/4X watertight aluminum specialist.',
                contacts: [],
                activities: [],
                createdAt: '2026-01-09T12:00:00Z',
                lastContact: null
            },
            {
                id: 205,
                companyName: 'American Products',
                contactType: 'manufacturing',
                partnerType: 'Fabricator',
                region: 'USA',
                website: 'https://amprod.us',
                linkedInUrl: '',
                address: 'Heartland USA',
                leadSource: 'cold_outreach',
                status: 'Not Contacted',
                priority: 'Medium',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 0,
                lostReason: '',
                followupDate: '',
                notes: 'TIER 2 - Since 1989. 100% Made in USA. BABA compliant for government contracts.',
                contacts: [],
                activities: [],
                createdAt: '2026-01-09T12:00:00Z',
                lastContact: null
            },
            {
                id: 206,
                companyName: 'Protocase',
                contactType: 'manufacturing',
                partnerType: 'Fabricator',
                region: 'USA',
                website: 'https://www.protocase.com',
                linkedInUrl: '',
                address: 'Nova Scotia, Canada',
                leadSource: 'cold_outreach',
                status: 'Not Contacted',
                priority: 'Medium',
                dealValue: 0,
                productsInterested: ['75"'],
                expectedCloseDate: '',
                winProbability: 0,
                lostReason: '',
                followupDate: '',
                notes: 'TIER 2 - FAST PROTOTYPES: 2-3 day turnaround. No minimum order. Ships to US. Best for urgent prototype needs.',
                contacts: [],
                activities: [],
                createdAt: '2026-01-09T12:00:00Z',
                lastContact: null
            }
        ];

        // ============ STORAGE ============
        async function loadData() {
            if (useSupabase) {
                try {
                    // Load partners from Supabase
                    const { data: partnersData, error: pError } = await supabaseClient
                        .from('partners')
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (!pError && partnersData && partnersData.length > 0) {
                        // Supabase has data - use it
                        // Load contacts and activities for each partner
                        const partnerIds = partnersData.map(p => p.id);

                        const { data: contactsData } = await supabaseClient
                            .from('partner_contacts')
                            .select('*')
                            .in('partner_id', partnerIds);

                        const { data: activitiesData } = await supabaseClient
                            .from('partner_activities')
                            .select('*')
                            .in('partner_id', partnerIds)
                            .order('timestamp', { ascending: false });

                        // Transform to local format
                        partners = partnersData.map(p => ({
                            id: p.id,
                            companyName: p.company_name,
                            contactType: p.contact_type || 'partner',
                            partnerType: p.partner_type,
                            region: p.region,
                            website: p.website,
                            linkedInUrl: p.linkedin_url,
                            address: p.address,
                            leadSource: p.lead_source,
                            status: p.status,
                            priority: p.priority,
                            dealValue: parseFloat(p.deal_value) || 0,
                            winProbability: p.win_probability,
                            expectedCloseDate: p.expected_close_date,
                            lostReason: p.lost_reason,
                            productsInterested: p.products_interested || [],
                            followupDate: p.followup_date,
                            notes: p.notes,
                            contacts: (contactsData || [])
                                .filter(c => c.partner_id === p.id)
                                .map(c => ({
                                    id: c.id,
                                    name: c.name,
                                    title: c.title,
                                    email: c.email,
                                    phone: c.phone,
                                    isPrimary: c.is_primary,
                                    isDecisionMaker: c.is_decision_maker
                                })),
                            activities: (activitiesData || [])
                                .filter(a => a.partner_id === p.id)
                                .map(a => ({
                                    id: a.id,
                                    type: a.activity_type,
                                    description: a.description,
                                    timestamp: a.timestamp
                                })),
                            createdAt: p.created_at,
                            lastContact: p.last_contact
                        }));
                        console.log(`Loaded ${partners.length} partners from Supabase`);
                        return;
                    } else if (!pError && (!partnersData || partnersData.length === 0)) {
                        // Supabase is empty - seed with initial data
                        console.log('Supabase is empty, seeding with initial data...');
                        await seedSupabaseWithInitialData();
                        return;
                    }
                } catch (e) {
                    console.error('Supabase load failed:', e);
                    alert('Failed to connect to CRM database. Please check your connection.');
                }
            }
        }

        // Seed Supabase with initial data when empty
        async function seedSupabaseWithInitialData() {
            console.log('Seeding Supabase with initial partners...');

            // Map CRM status values to valid database values (until constraints are dropped)
            const mapStatus = (s) => {
                if (['Proposal', 'Meeting', 'Won', 'Lost'].includes(s)) return 'Contacted';
                return s || 'Not Contacted';
            };

            for (const partner of initialPartners) {
                try {
                    // Insert partner (omit partner_type if it might violate constraint)
                    const partnerData = {
                        company_name: partner.companyName,
                        contact_type: partner.contactType || 'partner',
                        // partner_type omitted due to constraint issues
                        region: partner.region,
                        website: partner.website,
                        linkedin_url: partner.linkedInUrl,
                        address: partner.address,
                        lead_source: partner.leadSource,
                        status: mapStatus(partner.status),
                        priority: partner.priority,
                        deal_value: partner.dealValue || 0,
                        win_probability: partner.winProbability || 0,
                        expected_close_date: partner.expectedCloseDate || null,
                        lost_reason: partner.lostReason,
                        products_interested: partner.productsInterested || [],
                        followup_date: partner.followupDate || null,
                        notes: partner.notes,
                        last_contact: partner.lastContact,
                        created_at: partner.createdAt || new Date().toISOString()
                    };

                    const { data: insertedPartner, error: partnerError } = await supabaseClient
                        .from('partners')
                        .insert(partnerData)
                        .select('id')
                        .single();

                    if (partnerError) {
                        console.error(`Error inserting partner ${partner.companyName}:`, partnerError);
                        continue;
                    }

                    const newPartnerId = insertedPartner.id;

                    // Insert contacts
                    if (partner.contacts && partner.contacts.length > 0) {
                        const contactsData = partner.contacts.map(c => ({
                            partner_id: newPartnerId,
                            name: c.name,
                            title: c.title,
                            email: c.email,
                            phone: c.phone,
                            is_primary: c.isPrimary || false,
                            is_decision_maker: c.isDecisionMaker || false
                        }));

                        const { error: contactsError } = await supabaseClient
                            .from('partner_contacts')
                            .insert(contactsData);

                        if (contactsError) {
                            console.error(`Error inserting contacts for ${partner.companyName}:`, contactsError);
                        }
                    }

                    // Insert activities
                    if (partner.activities && partner.activities.length > 0) {
                        const activitiesData = partner.activities.map(a => ({
                            partner_id: newPartnerId,
                            activity_type: a.type,
                            description: a.description,
                            timestamp: a.timestamp
                        }));

                        const { error: activitiesError } = await supabaseClient
                            .from('partner_activities')
                            .insert(activitiesData);

                        if (activitiesError) {
                            console.error(`Error inserting activities for ${partner.companyName}:`, activitiesError);
                        }
                    }

                    console.log(`Seeded: ${partner.companyName}`);
                } catch (e) {
                    console.error(`Error seeding ${partner.companyName}:`, e);
                }
            }

            console.log('Seeding complete. Reloading data from Supabase...');

            // Now reload the data from Supabase to get proper UUIDs
            const { data: partnersData } = await supabaseClient
                .from('partners')
                .select('*')
                .order('created_at', { ascending: false });

            if (partnersData && partnersData.length > 0) {
                const partnerIds = partnersData.map(p => p.id);

                const { data: contactsData } = await supabaseClient
                    .from('partner_contacts')
                    .select('*')
                    .in('partner_id', partnerIds);

                const { data: activitiesData } = await supabaseClient
                    .from('partner_activities')
                    .select('*')
                    .in('partner_id', partnerIds)
                    .order('timestamp', { ascending: false });

                partners = partnersData.map(p => ({
                    id: p.id,
                    companyName: p.company_name,
                    contactType: p.contact_type || 'partner',
                    partnerType: p.partner_type,
                    region: p.region,
                    website: p.website,
                    linkedInUrl: p.linkedin_url,
                    address: p.address,
                    leadSource: p.lead_source,
                    status: p.status,
                    priority: p.priority,
                    dealValue: parseFloat(p.deal_value) || 0,
                    winProbability: p.win_probability,
                    expectedCloseDate: p.expected_close_date,
                    lostReason: p.lost_reason,
                    productsInterested: p.products_interested || [],
                    followupDate: p.followup_date,
                    notes: p.notes,
                    contacts: (contactsData || [])
                        .filter(c => c.partner_id === p.id)
                        .map(c => ({
                            id: c.id,
                            name: c.name,
                            title: c.title,
                            email: c.email,
                            phone: c.phone,
                            isPrimary: c.is_primary,
                            isDecisionMaker: c.is_decision_maker
                        })),
                    activities: (activitiesData || [])
                        .filter(a => a.partner_id === p.id)
                        .map(a => ({
                            id: a.id,
                            type: a.activity_type,
                            description: a.description,
                            timestamp: a.timestamp
                        })),
                    createdAt: p.created_at,
                    lastContact: p.last_contact
                }));

                console.log(`Loaded ${partners.length} partners from Supabase after seeding`);
            }
        }

        // Save a partner to Supabase
        async function savePartnerToSupabase(partner) {
            if (!useSupabase) return;

            try {
                // Check if partner exists (has UUID format id)
                const isExisting = typeof partner.id === 'string' && partner.id.includes('-');

                const partnerData = {
                    company_name: partner.companyName,
                    contact_type: partner.contactType || 'partner',
                    partner_type: partner.partnerType,
                    region: partner.region,
                    website: partner.website,
                    linkedin_url: partner.linkedInUrl,
                    address: partner.address,
                    lead_source: partner.leadSource,
                    status: partner.status,
                    priority: partner.priority,
                    deal_value: partner.dealValue,
                    win_probability: partner.winProbability,
                    expected_close_date: partner.expectedCloseDate || null,
                    lost_reason: partner.lostReason,
                    products_interested: partner.productsInterested,
                    followup_date: partner.followupDate || null,
                    notes: partner.notes,
                    last_contact: partner.lastContact
                };

                let partnerId;
                if (isExisting) {
                    // Update existing
                    await supabaseClient.from('partners').update(partnerData).eq('id', partner.id);
                    partnerId = partner.id;
                } else {
                    // Insert new
                    const { data } = await supabaseClient.from('partners').insert(partnerData).select('id').single();
                    if (data) partnerId = data.id;
                }

                // Sync contacts if we have a partnerId
                if (partnerId && partner.contacts?.length > 0) {
                    // Delete existing contacts and re-insert
                    await supabaseClient.from('partner_contacts').delete().eq('partner_id', partnerId);

                    const contactsData = partner.contacts.map(c => ({
                        partner_id: partnerId,
                        name: c.name,
                        title: c.title,
                        email: c.email,
                        phone: c.phone,
                        is_primary: c.isPrimary,
                        is_decision_maker: c.isDecisionMaker
                    }));
                    await supabaseClient.from('partner_contacts').insert(contactsData);
                }

                console.log('Partner saved to Supabase');
            } catch (e) {
                console.error('Supabase save error:', e);
            }
        }

        // Save an activity to Supabase
        async function saveActivityToSupabase(partnerId, activity) {
            if (!useSupabase) return;

            try {
                await supabaseClient.from('partner_activities').insert({
                    partner_id: partnerId,
                    activity_type: activity.type,
                    description: activity.description,
                    timestamp: activity.timestamp
                });
                console.log('Activity saved to Supabase');
            } catch (e) {
                console.error('Activity save error:', e);
            }
        }

        // ============ LIST VIEW ============
        function renderList() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const regionFilter = document.getElementById('regionFilter').value;

            let filtered = partners.filter(p => {
                // Contact type filter (from tabs)
                if (contactTypeFilter && p.contactType !== contactTypeFilter) return false;
                // Search
                if (search && !p.companyName.toLowerCase().includes(search) &&
                    !p.notes?.toLowerCase().includes(search)) return false;
                if (typeFilter && p.partnerType !== typeFilter) return false;
                // "live" = everything except Not Contacted
                if (statusFilter === 'live' && p.status === 'Not Contacted') return false;
                if (statusFilter && statusFilter !== 'live' && p.status !== statusFilter) return false;
                if (regionFilter && p.region !== regionFilter) return false;
                return true;
            });

            // Sort by priority then name
            filtered.sort((a, b) => {
                const priorityOrder = { 'High': 0, 'Medium': 1, 'Low': 2 };
                const pA = priorityOrder[a.priority] ?? 2;
                const pB = priorityOrder[b.priority] ?? 2;
                if (pA !== pB) return pA - pB;
                return a.companyName.localeCompare(b.companyName);
            });

            const listHtml = filtered.map(p => {
                const typeClass = 'badge-type-' + (p.partnerType || 'other').toLowerCase().replace(/[\s\/]+/g, '-');
                const statusClass = 'badge-status-' + (p.status || 'unknown').toLowerCase().replace(/\s+/g, '-');
                const contactTypeClass = 'badge-contact-' + (p.contactType || 'partner');
                const contactTypeLabel = { manufacturing: 'Manufacturing', partner: 'Partner', commercial: 'Commercial', retail: 'Retail' }[p.contactType] || 'Partner';
                const primaryContact = p.contacts?.find(c => c.isPrimary) || p.contacts?.[0];

                return `
                    <div class="partner-item ${selectedPartnerId === p.id ? 'active' : ''}" onclick="selectPartner('${p.id}')">
                        <div class="partner-name">${p.companyName}</div>
                        <div class="partner-meta">${primaryContact?.name || 'No contact'} &middot; ${p.region}</div>
                        <div class="partner-badges">
                            <span class="badge ${contactTypeClass}">${contactTypeLabel}</span>
                            <span class="badge ${typeClass}">${p.partnerType}</span>
                            <span class="badge ${statusClass}">${p.status}</span>
                            ${p.priority === 'High' ? '<span class="badge badge-priority-high">High</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('partnerList').innerHTML = listHtml || '<div style="padding: 2rem; text-align: center; color: var(--text-muted);">No partners found</div>';
            updateStats();
            updateTypeCounts();
        }

        // Contact type filter
        function setContactTypeFilter(type) {
            contactTypeFilter = type;
            renderList();
        }

        // Update contact type counts (no-op, tabs removed)
        function updateTypeCounts() {}

        function updateStats() {
            document.getElementById('totalPartners').textContent = partners.length;

            const active = partners.filter(p => !['Won', 'Lost', 'Not Contacted'].includes(p.status)).length;
            document.getElementById('activeDeals').textContent = active;

            const pipeline = partners.reduce((sum, p) => sum + (p.dealValue || 0), 0);
            document.getElementById('pipelineValue').textContent = pipeline > 0 ? (pipeline / 1000).toFixed(0) + 'K' : '0';

            const today = new Date().toISOString().split('T')[0];
            const followups = partners.filter(p => p.followupDate && p.followupDate <= today).length;
            document.getElementById('followupsToday').textContent = followups;
        }

        // ============ DETAIL VIEW ============
        function selectPartner(id) {
            selectedPartnerId = id;
            renderList();
            renderDetail();
            document.getElementById('detailPanel').classList.add('active');
        }

        function renderDetail() {
            const p = partners.find(p => p.id === selectedPartnerId);
            if (!p) {
                document.getElementById('detailEmpty').style.display = 'flex';
                document.getElementById('detailContent').style.display = 'none';
                return;
            }

            document.getElementById('detailEmpty').style.display = 'none';
            document.getElementById('detailContent').style.display = 'block';

            const typeClass = 'badge-type-' + p.partnerType.toLowerCase().replace(/[\s\/]+/g, '-');
            const statusClass = 'badge-status-' + p.status.toLowerCase().replace(/\s+/g, '-');
            const contactTypeClass = 'badge-contact-' + (p.contactType || 'partner');
            const contactTypeLabel = { manufacturing: 'Manufacturing', partner: 'Partner', commercial: 'Commercial', retail: 'Retail' }[p.contactType] || 'Partner';

            const html = `
                <button class="btn btn-outline back-btn" onclick="closeDetail()" style="margin-bottom: 1rem;">&larr; Back</button>

                <div class="detail-header">
                    <div>
                        <div class="detail-title">${p.companyName}</div>
                        <div class="detail-subtitle">
                            <span class="badge ${contactTypeClass}">${contactTypeLabel}</span>
                            <span class="badge ${typeClass}">${p.partnerType}</span>
                            <span class="badge ${statusClass}">${p.status}</span>
                            <span class="badge badge-priority-${p.priority.toLowerCase()}">${p.priority} Priority</span>
                        </div>
                    </div>
                    <div class="detail-actions">
                        <button class="btn btn-primary btn-small" onclick="scheduleMeeting('${p.id}')"> Schedule Meeting</button>
                        <button class="btn btn-outline btn-small" onclick="editPartnerField('status')">Update Status</button>
                        <button class="btn btn-danger btn-small" onclick="deletePartner('${p.id}')">Delete</button>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('overview')">Overview</button>
                    <button class="tab" onclick="switchTab('contacts')">Contacts (${p.contacts?.length || 0})</button>
                    <button class="tab" onclick="switchTab('deal')">Deal</button>
                    <button class="tab" onclick="switchTab('business')">Business</button>
                    <button class="tab" onclick="switchTab('activity')">Activity (${p.activities?.length || 0})</button>
                </div>

                <!-- Overview Tab -->
                <div class="tab-content active" id="tab-overview">
                    <div class="card">
                        <div class="card-header">Company Information</div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Website</label>
                                    <div class="form-value">${p.website ? `<a href="${p.website}" target="_blank">${p.website}</a>` : '-'}</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">LinkedIn</label>
                                    <div class="form-value">${p.linkedInUrl ? `<a href="${p.linkedInUrl}" target="_blank">View Profile</a>` : '-'}</div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Address</label>
                                    <div class="form-value">${p.address || '-'}</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Lead Source</label>
                                    <div class="form-value">${p.leadSource?.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) || '-'}</div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Follow-up Date</label>
                                    <div class="form-value">${p.followupDate ? formatDate(p.followupDate) : '-'}</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Last Contact</label>
                                    <div class="form-value">${p.lastContact ? formatDate(p.lastContact) : 'Never'}</div>
                                </div>
                            </div>
                            <button class="btn btn-outline btn-small" onclick="showEditCompanyModal()">Edit Company Info</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">Notes</div>
                        <div class="card-body">
                            <textarea class="form-textarea" id="partnerNotes" onblur="saveNotes()" style="min-height: 100px;">${p.notes || ''}</textarea>
                        </div>
                    </div>
                </div>

                <!-- Contacts Tab -->
                <div class="tab-content" id="tab-contacts">
                    <div class="card">
                        <div class="card-header">
                            <span>Contacts</span>
                            <button class="btn btn-primary btn-small" onclick="showAddContactModal()">+ Add Contact</button>
                        </div>
                        <div class="card-body">
                            ${p.contacts?.length ? p.contacts.map(c => `
                                <div class="contact-item">
                                    <div class="contact-info">
                                        <div class="contact-name">${c.name || 'Unnamed Contact'}</div>
                                        <div class="contact-title">${c.title || 'No title'}</div>
                                        <div class="contact-details">
                                            ${c.email ? `<a href="mailto:${c.email}">${c.email}</a>` : ''}
                                            ${c.email && c.phone ? ' &middot; ' : ''}
                                            ${c.phone || ''}
                                        </div>
                                        <div class="contact-badges">
                                            ${c.isPrimary ? '<span class="badge badge-primary">Primary</span>' : ''}
                                            ${c.isDecisionMaker ? '<span class="badge badge-dm">Decision Maker</span>' : ''}
                                        </div>
                                    </div>
                                    <button class="btn btn-outline btn-small" onclick="deleteContact(${c.id})">Remove</button>
                                </div>
                            `).join('') : '<div style="text-align: center; color: var(--text-muted); padding: 2rem;">No contacts yet. Add one to get started.</div>'}
                        </div>
                    </div>
                </div>

                <!-- Deal Tab -->
                <div class="tab-content" id="tab-deal">
                    <div class="card">
                        <div class="card-header">
                            <span>Deal Information</span>
                            <button class="btn btn-outline btn-small" onclick="showEditDealModal()">Edit Deal</button>
                        </div>
                        <div class="card-body">
                            <div class="deal-grid">
                                <div class="deal-stat">
                                    <div class="deal-stat-value">AED ${(p.dealValue || 0).toLocaleString()}</div>
                                    <div class="deal-stat-label">Deal Value</div>
                                </div>
                                <div class="deal-stat">
                                    <div class="deal-stat-value">${p.winProbability || 0}%</div>
                                    <div class="deal-stat-label">Win Probability</div>
                                </div>
                                <div class="deal-stat">
                                    <div class="deal-stat-value">${p.expectedCloseDate ? formatDate(p.expectedCloseDate) : '-'}</div>
                                    <div class="deal-stat-label">Expected Close</div>
                                </div>
                            </div>
                            <div style="margin-top: 1rem;">
                                <label class="form-label">Products Interested</label>
                                <div class="products-interested">
                                    ${['55"', '65"', '75"'].map(size => `
                                        <span class="product-tag ${p.productsInterested?.includes(size) ? '' : 'inactive'}">${size}</span>
                                    `).join('')}
                                </div>
                            </div>
                            ${p.status === 'Lost' && p.lostReason ? `
                                <div style="margin-top: 1rem; padding: 0.75rem; background: #fee2e2; border-radius: 6px;">
                                    <strong>Lost Reason:</strong> ${p.lostReason}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>

                <!-- Business Tab -->
                <div class="tab-content" id="tab-business">
                    <div class="card">
                        <div class="card-header">
                            <span>Business Information</span>
                            <button class="btn btn-outline btn-small" onclick="showEditBusinessModal()">Edit</button>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Trade License</label>
                                    <div class="form-value">${p.tradeLicense || '-'}</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">TRN (Tax Registration)</label>
                                    <div class="form-value">${p.trn || '-'}</div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Payment Terms</label>
                                    <div class="form-value">${p.paymentTerms || '-'}</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Credit Limit</label>
                                    <div class="form-value">${p.creditLimit ? 'AED ' + p.creditLimit.toLocaleString() : '-'}</div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Contract Status</label>
                                    <div class="form-value">${p.contractStatus || 'None'}</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Contract Expiry</label>
                                    <div class="form-value">${p.contractExpiry ? formatDate(p.contractExpiry) : '-'}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">Bank Details</div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Bank Name</label>
                                    <div class="form-value">${p.bankName || '-'}</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Account Name</label>
                                    <div class="form-value">${p.bankAccountName || '-'}</div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">IBAN</label>
                                <div class="form-value" style="font-family: monospace;">${p.iban || '-'}</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">SWIFT/BIC</label>
                                <div class="form-value" style="font-family: monospace;">${p.swiftCode || '-'}</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">Billing Address</div>
                        <div class="card-body">
                            <div class="form-value" style="white-space: pre-line;">${p.billingAddress || 'Same as company address'}</div>
                        </div>
                    </div>
                </div>

                <!-- Activity Tab -->
                <div class="tab-content" id="tab-activity">
                    <div class="card">
                        <div class="card-header">Activity Timeline</div>
                        <div class="card-body">
                            <div class="add-activity-form">
                                <select class="form-select" id="newActivityType">
                                    ${Object.entries(activityTypes).map(([k, v]) => `<option value="${k}">${v}</option>`).join('')}
                                </select>
                                <input type="text" class="form-input" id="newActivityDesc" placeholder="Describe the activity...">
                                <button class="btn btn-primary" onclick="addActivity()">Add</button>
                            </div>

                            <div class="activity-timeline">
                                ${p.activities?.length ? [...p.activities].reverse().map(a => `
                                    <div class="activity-item type-${a.type}">
                                        <div class="activity-header">
                                            <span class="activity-type">${activityTypes[a.type] || a.type}</span>
                                            <span class="activity-date">${formatDateTime(a.timestamp)}</span>
                                        </div>
                                        <div class="activity-desc">${a.description}</div>
                                    </div>
                                `).join('') : '<div style="text-align: center; color: var(--text-muted); padding: 2rem;">No activities yet.</div>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('detailContent').innerHTML = html;
        }

        function closeDetail() {
            selectedPartnerId = null;
            document.getElementById('detailPanel').classList.remove('active');
            document.getElementById('detailEmpty').style.display = 'flex';
            document.getElementById('detailContent').style.display = 'none';
            renderList();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + tabId).classList.add('active');
        }

        // ============ CRUD OPERATIONS ============
        function showNewPartnerModal() {
            document.getElementById('newPartnerForm').reset();
            document.getElementById('newPartnerModal').classList.add('active');
        }

        function showAddContactModal() {
            document.getElementById('addContactForm').reset();
            document.getElementById('addContactModal').classList.add('active');
        }

        function closeModal() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
        }

        function createPartner(e) {
            e.preventDefault();

            const newPartner = {
                id: Date.now(),
                companyName: document.getElementById('newCompanyName').value,
                contactType: document.getElementById('newContactType').value,
                partnerType: document.getElementById('newPartnerType').value,
                region: document.getElementById('newRegion').value,
                website: document.getElementById('newWebsite').value || '',
                linkedInUrl: '',
                address: '',
                leadSource: document.getElementById('newLeadSource').value,
                status: 'Not Contacted',
                priority: 'Medium',
                dealValue: 0,
                productsInterested: [],
                expectedCloseDate: '',
                winProbability: 0,
                lostReason: '',
                followupDate: '',
                notes: document.getElementById('newNotes').value || '',
                contacts: [],
                activities: [],
                createdAt: new Date().toISOString(),
                lastContact: null
            };

            // Add contact if provided
            const contactName = document.getElementById('newContactName').value;
            const contactEmail = document.getElementById('newEmail').value;
            const contactPhone = document.getElementById('newPhone').value;

            if (contactName || contactEmail || contactPhone) {
                newPartner.contacts.push({
                    id: 1,
                    name: contactName,
                    title: '',
                    email: contactEmail,
                    phone: contactPhone,
                    isPrimary: true,
                    isDecisionMaker: false
                });
            }

            partners.push(newPartner);
            savePartnerToSupabase(newPartner);
            closeModal();
            selectPartner(newPartner.id);
        }

        function addContact(e) {
            e.preventDefault();
            const p = partners.find(p => p.id === selectedPartnerId);
            if (!p) return;

            const newContact = {
                id: Date.now(),
                name: document.getElementById('contactName').value,
                title: document.getElementById('contactTitle').value,
                email: document.getElementById('contactEmail').value,
                phone: document.getElementById('contactPhone').value,
                isPrimary: document.getElementById('contactIsPrimary').checked,
                isDecisionMaker: document.getElementById('contactIsDecisionMaker').checked
            };

            if (newContact.isPrimary) {
                p.contacts.forEach(c => c.isPrimary = false);
            }

            p.contacts.push(newContact);
            savePartnerToSupabase(p);
            closeModal();
            renderDetail();
            renderList();
        }

        function deleteContact(contactId) {
            if (!confirm('Remove this contact?')) return;
            const p = partners.find(p => p.id === selectedPartnerId);
            if (!p) return;
            p.contacts = p.contacts.filter(c => c.id !== contactId);
            savePartnerToSupabase(p);
            renderDetail();
        }

        function scheduleMeeting(id) {
            const p = partners.find(p => p.id === id);
            if (!p) return;

            // Get primary contact email
            const primaryContact = p.contacts?.find(c => c.isPrimary) || p.contacts?.[0];
            const email = primaryContact?.email || '';
            const contactName = primaryContact?.name || '';

            // Build Google Calendar URL
            const title = encodeURIComponent(`Meeting: ${p.companyName}`);
            const details = encodeURIComponent(`Meeting with ${p.companyName}${contactName ? ' (' + contactName + ')' : ''}\n\nNotes:\n${p.notes || ''}`);
            const location = encodeURIComponent(p.address || '');

            let calUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&details=${details}`;
            if (location) calUrl += `&location=${location}`;
            if (email) calUrl += `&add=${encodeURIComponent(email)}`;

            window.open(calUrl, '_blank');

            // Log activity
            addActivityDirect('meeting', `Scheduled meeting via calendar`);
        }

        function deletePartner(id) {
            if (!confirm('Delete this partner? This cannot be undone.')) return;
            partners = partners.filter(p => p.id !== id);
            // TODO: Add deletePartnerFromSupabase(id)
            closeDetail();
            renderList();
        }

        function saveNotes() {
            const p = partners.find(p => p.id === selectedPartnerId);
            if (!p) return;
            p.notes = document.getElementById('partnerNotes').value;
            savePartnerToSupabase(p);
        }

        function addActivityDirect(type, description) {
            const p = partners.find(p => p.id === selectedPartnerId);
            if (!p) return;

            const activity = {
                id: Date.now(),
                type: type,
                description: description,
                timestamp: new Date().toISOString()
            };

            p.activities = p.activities || [];
            p.activities.push(activity);
            p.lastContact = activity.timestamp;
            savePartnerToSupabase(p);
            renderDetail();
        }

        function addActivity() {
            const p = partners.find(p => p.id === selectedPartnerId);
            if (!p) return;

            const type = document.getElementById('newActivityType').value;
            const desc = document.getElementById('newActivityDesc').value;
            if (!desc.trim()) return alert('Please enter a description');

            const activity = {
                id: Date.now(),
                type: type,
                description: desc,
                timestamp: new Date().toISOString()
            };

            p.activities = p.activities || [];
            p.activities.push(activity);
            p.lastContact = activity.timestamp;

            // Update status if needed
            if (p.status === 'Not Contacted') {
                p.status = 'Contacted';
            }

            savePartnerToSupabase(p);
            saveActivityToSupabase(p.id, activity);
            document.getElementById('newActivityDesc').value = '';
            renderDetail();
            renderList();
            switchTab('activity'); // Stay on activity tab
        }

        function editPartnerField(field) {
            const p = partners.find(p => p.id === selectedPartnerId);
            if (!p) return;

            if (field === 'status') {
                const statuses = ['Not Contacted', 'Contacted', 'Responded', 'Meeting', 'Quoted', 'Won', 'Lost'];
                const current = statuses.indexOf(p.status);
                const newStatus = prompt(`Current: ${p.status}\n\nEnter new status:\n${statuses.map((s, i) => `${i + 1}. ${s}`).join('\n')}`);

                if (newStatus && statuses[parseInt(newStatus) - 1]) {
                    p.status = statuses[parseInt(newStatus) - 1];

                    if (p.status === 'Lost') {
                        const reason = prompt('Why was this deal lost?');
                        if (reason) p.lostReason = reason;
                    }

                    savePartnerToSupabase(p);
                    renderDetail();
                    renderList();
                }
            }
        }

        function showEditCompanyModal() {
            const p = partners.find(p => p.id === selectedPartnerId);
            if (!p) return;

            const html = `
                <div class="modal-overlay active" id="editCompanyModal" onclick="if(event.target===this)closeModal()">
                    <div class="modal">
                        <div class="modal-header">
                            <span class="modal-title">Edit Company Info</span>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <form onsubmit="saveCompanyInfo(event)">
                            <div class="form-group" style="margin-bottom: 0.75rem;">
                                <label class="form-label">Company Name *</label>
                                <input type="text" class="form-input" id="editCompanyName" value="${p.companyName}" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Type</label>
                                    <select class="form-select" id="editPartnerType">
                                        ${['Fabricator', 'AV Integrator', 'Pool/Landscape', 'Hospitality', 'Designer', 'Developer', 'Distributor', 'Contractor', 'Other'].map(t =>
                                            `<option value="${t}" ${p.partnerType === t ? 'selected' : ''}>${t}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Region</label>
                                    <select class="form-select" id="editRegion">
                                        ${['UAE', 'GCC', 'China', 'Europe', 'USA', 'Other'].map(r =>
                                            `<option value="${r}" ${p.region === r ? 'selected' : ''}>${r}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Website</label>
                                    <input type="url" class="form-input" id="editWebsite" value="${p.website || ''}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">LinkedIn</label>
                                    <input type="url" class="form-input" id="editLinkedIn" value="${p.linkedInUrl || ''}">
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 0.75rem;">
                                <label class="form-label">Address</label>
                                <input type="text" class="form-input" id="editAddress" value="${p.address || ''}">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Priority</label>
                                    <select class="form-select" id="editPriority">
                                        ${['Low', 'Medium', 'High'].map(pr =>
                                            `<option value="${pr}" ${p.priority === pr ? 'selected' : ''}>${pr}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Follow-up Date</label>
                                    <input type="date" class="form-input" id="editFollowup" value="${p.followupDate || ''}">
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                                <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function saveCompanyInfo(e) {
            e.preventDefault();
            const p = partners.find(p => p.id === selectedPartnerId);
            if (!p) return;

            p.companyName = document.getElementById('editCompanyName').value;
            p.partnerType = document.getElementById('editPartnerType').value;
            p.region = document.getElementById('editRegion').value;
            p.website = document.getElementById('editWebsite').value;
            p.linkedInUrl = document.getElementById('editLinkedIn').value;
            p.address = document.getElementById('editAddress').value;
            p.priority = document.getElementById('editPriority').value;
            p.followupDate = document.getElementById('editFollowup').value;

            savePartnerToSupabase(p);
            document.getElementById('editCompanyModal').remove();
            renderDetail();
            renderList();
        }

        function showEditBusinessModal() {
            const p = partners.find(p => p.id === selectedPartnerId);
            if (!p) return;

            const html = `
                <div class="modal-overlay active" id="editBusinessModal" onclick="if(event.target===this)closeModal()">
                    <div class="modal" style="max-width: 600px;">
                        <div class="modal-header">
                            <span class="modal-title">Edit Business Information</span>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <form onsubmit="saveBusinessInfo(event)">
                            <div style="max-height: 70vh; overflow-y: auto; padding-right: 0.5rem;">
                                <h4 style="margin-bottom: 0.75rem; color: var(--primary);">Legal & Tax</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Trade License Number</label>
                                        <input type="text" class="form-input" id="editTradeLicense" value="${p.tradeLicense || ''}" placeholder="e.g., 123456">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">TRN (Tax Registration)</label>
                                        <input type="text" class="form-input" id="editTrn" value="${p.trn || ''}" placeholder="e.g., 100123456700003">
                                    </div>
                                </div>

                                <h4 style="margin: 1.25rem 0 0.75rem; color: var(--primary);">Payment</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Payment Terms</label>
                                        <select class="form-select" id="editPaymentTerms">
                                            ${['', 'COD', 'Net 15', 'Net 30', 'Net 45', 'Net 60', 'Net 90', '50% Advance', 'Custom'].map(t =>
                                                `<option value="${t}" ${p.paymentTerms === t ? 'selected' : ''}>${t || 'Not Set'}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Credit Limit (AED)</label>
                                        <input type="number" class="form-input" id="editCreditLimit" value="${p.creditLimit || ''}" placeholder="e.g., 50000">
                                    </div>
                                </div>

                                <h4 style="margin: 1.25rem 0 0.75rem; color: var(--primary);">Contract</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Contract Status</label>
                                        <select class="form-select" id="editContractStatus">
                                            ${['None', 'Negotiating', 'Active', 'Expired', 'Terminated'].map(s =>
                                                `<option value="${s}" ${p.contractStatus === s ? 'selected' : ''}>${s}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Contract Expiry</label>
                                        <input type="date" class="form-input" id="editContractExpiry" value="${p.contractExpiry || ''}">
                                    </div>
                                </div>

                                <h4 style="margin: 1.25rem 0 0.75rem; color: var(--primary);">Bank Details</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Bank Name</label>
                                        <input type="text" class="form-input" id="editBankName" value="${p.bankName || ''}" placeholder="e.g., Emirates NBD">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Account Name</label>
                                        <input type="text" class="form-input" id="editBankAccountName" value="${p.bankAccountName || ''}" placeholder="Company name on account">
                                    </div>
                                </div>
                                <div class="form-group" style="margin-bottom: 0.75rem;">
                                    <label class="form-label">IBAN</label>
                                    <input type="text" class="form-input" id="editIban" value="${p.iban || ''}" placeholder="e.g., AE070331234567890123456" style="font-family: monospace;">
                                </div>
                                <div class="form-group" style="margin-bottom: 0.75rem;">
                                    <label class="form-label">SWIFT/BIC Code</label>
                                    <input type="text" class="form-input" id="editSwift" value="${p.swiftCode || ''}" placeholder="e.g., EABORAEAXXX" style="font-family: monospace;">
                                </div>

                                <h4 style="margin: 1.25rem 0 0.75rem; color: var(--primary);">Billing Address</h4>
                                <div class="form-group">
                                    <textarea class="form-textarea" id="editBillingAddress" rows="3" placeholder="Leave blank to use company address">${p.billingAddress || ''}</textarea>
                                </div>
                            </div>

                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                                <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function saveBusinessInfo(e) {
            e.preventDefault();
            const p = partners.find(p => p.id === selectedPartnerId);
            if (!p) return;

            p.tradeLicense = document.getElementById('editTradeLicense').value;
            p.trn = document.getElementById('editTrn').value;
            p.paymentTerms = document.getElementById('editPaymentTerms').value;
            p.creditLimit = parseInt(document.getElementById('editCreditLimit').value) || 0;
            p.contractStatus = document.getElementById('editContractStatus').value;
            p.contractExpiry = document.getElementById('editContractExpiry').value;
            p.bankName = document.getElementById('editBankName').value;
            p.bankAccountName = document.getElementById('editBankAccountName').value;
            p.iban = document.getElementById('editIban').value;
            p.swiftCode = document.getElementById('editSwift').value;
            p.billingAddress = document.getElementById('editBillingAddress').value;

            savePartnerToSupabase(p);
            document.getElementById('editBusinessModal').remove();
            renderDetail();
        }

        function showEditDealModal() {
            const p = partners.find(p => p.id === selectedPartnerId);
            if (!p) return;

            const html = `
                <div class="modal-overlay active" id="editDealModal" onclick="if(event.target===this)closeModal()">
                    <div class="modal">
                        <div class="modal-header">
                            <span class="modal-title">Edit Deal Information</span>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <form onsubmit="saveDealInfo(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Deal Value (AED)</label>
                                    <input type="number" class="form-input" id="editDealValue" value="${p.dealValue || 0}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Win Probability (%)</label>
                                    <input type="number" class="form-input" id="editWinProb" min="0" max="100" value="${p.winProbability || 0}">
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 0.75rem;">
                                <label class="form-label">Expected Close Date</label>
                                <input type="date" class="form-input" id="editCloseDate" value="${p.expectedCloseDate || ''}">
                            </div>
                            <div class="form-group" style="margin-bottom: 0.75rem;">
                                <label class="form-label">Products Interested</label>
                                <div style="display: flex; gap: 1rem;">
                                    ${['55"', '65"', '75"'].map(size => `
                                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="checkbox" value="${size}" ${p.productsInterested?.includes(size) ? 'checked' : ''} class="productCheckbox">
                                            ${size}
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                                <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function saveDealInfo(e) {
            e.preventDefault();
            const p = partners.find(p => p.id === selectedPartnerId);
            if (!p) return;

            p.dealValue = parseInt(document.getElementById('editDealValue').value) || 0;
            p.winProbability = parseInt(document.getElementById('editWinProb').value) || 0;
            p.expectedCloseDate = document.getElementById('editCloseDate').value;
            p.productsInterested = Array.from(document.querySelectorAll('.productCheckbox:checked')).map(cb => cb.value);

            savePartnerToSupabase(p);
            document.getElementById('editDealModal').remove();
            renderDetail();
            renderList();
        }

        // ============ UTILITIES ============
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', async () => {
            initSupabase();
            await loadData();
            renderList();
        });

        // Close modals on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
    </script>
    <script src="nav.js"></script>

    <!-- AI CRM Assistant -->
    <style>
        .ai-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            height: 52px;
            padding: 0 20px 0 16px;
            border-radius: 26px;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.45);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
            z-index: 1000;
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
        }
        .ai-fab:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 24px rgba(139, 92, 246, 0.55);
        }
        .ai-fab svg {
            width: 24px;
            height: 24px;
            fill: white;
        }
        .ai-fab-pulse {
            position: absolute;
            inset: -3px;
            border-radius: 30px;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            opacity: 0;
            animation: ai-pulse 2s ease-in-out infinite;
            z-index: -1;
        }
        @keyframes ai-pulse {
            0%, 100% { opacity: 0; transform: scale(1); }
            50% { opacity: 0.3; transform: scale(1.08); }
        }

        .ai-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 1001;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .ai-modal-overlay.active {
            display: flex;
        }

        .ai-modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .ai-modal-header {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: white;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .ai-modal-header h3 {
            margin: 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .ai-modal-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.5rem;
            line-height: 1;
            opacity: 0.8;
        }
        .ai-modal-close:hover { opacity: 1; }

        .ai-modal-body {
            padding: 20px;
        }

        .ai-input-area {
            position: relative;
        }
        .ai-input-area.drag-over textarea {
            border-color: #8b5cf6;
            background: #f5f3ff;
        }
        .ai-drop-overlay {
            position: absolute;
            inset: 0;
            background: rgba(139, 92, 246, 0.95);
            border-radius: 12px;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            pointer-events: none;
        }
        .ai-input-area.drag-over .ai-drop-overlay {
            display: flex;
        }
        .ai-drop-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }
        .ai-file-preview {
            display: none;
            margin-top: 8px;
            padding: 10px 12px;
            background: #f3f4f6;
            border-radius: 8px;
            font-size: 0.85rem;
            align-items: center;
            gap: 8px;
        }
        .ai-file-preview.active {
            display: flex;
        }
        .ai-file-preview .file-icon {
            font-size: 1.2rem;
        }
        .ai-file-preview .file-info {
            flex: 1;
        }
        .ai-file-preview .file-name {
            font-weight: 500;
            color: #374151;
        }
        .ai-file-preview .file-size {
            color: #6b7280;
            font-size: 0.75rem;
        }
        .ai-file-preview .file-remove {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0 4px;
        }
        .ai-file-preview .file-remove:hover {
            color: #ef4444;
        }
        .ai-input-area textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 0.95rem;
            resize: vertical;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        .ai-input-area textarea:focus {
            outline: none;
            border-color: #8b5cf6;
        }
        .ai-input-area textarea::placeholder {
            color: #9ca3af;
        }

        .ai-examples {
            margin-top: 12px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
        }
        .ai-examples-title {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .ai-example {
            font-size: 0.85rem;
            color: #4b5563;
            padding: 4px 0;
            cursor: pointer;
        }
        .ai-example:hover {
            color: #8b5cf6;
        }
        .ai-example::before {
            content: ' ';
            color: #8b5cf6;
        }

        .ai-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        .ai-btn {
            flex: 1;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .ai-btn-primary {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: white;
            border: none;
        }
        .ai-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }
        .ai-btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .ai-btn-secondary {
            background: white;
            color: #4b5563;
            border: 2px solid #e5e7eb;
        }
        .ai-btn-secondary:hover {
            border-color: #8b5cf6;
            color: #8b5cf6;
        }

        .ai-response {
            margin-top: 16px;
            padding: 16px;
            border-radius: 12px;
            display: none;
        }
        .ai-response.success {
            background: #ecfdf5;
            border: 1px solid #10b981;
            display: block;
        }
        .ai-response.error {
            background: #fef2f2;
            border: 1px solid #ef4444;
            display: block;
        }
        .ai-response.pending {
            background: #f3f4f6;
            border: 1px solid #9ca3af;
            display: block;
        }
        .ai-response-title {
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .ai-response.success .ai-response-title { color: #059669; }
        .ai-response.error .ai-response-title { color: #dc2626; }
        .ai-response.pending .ai-response-title { color: #6b7280; }

        .ai-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #e5e7eb;
            border-top-color: #8b5cf6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Voice Input Button */
        .ai-voice-btn {
            position: absolute;
            bottom: 12px;
            right: 12px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 2;
        }
        .ai-voice-btn:hover {
            background: #e5e7eb;
            border-color: #8b5cf6;
        }
        .ai-voice-btn svg {
            width: 20px;
            height: 20px;
            fill: #6b7280;
        }
        .ai-voice-btn:hover svg {
            fill: #8b5cf6;
        }
        .ai-voice-btn.listening {
            background: #dc2626;
            border-color: #dc2626;
            animation: voice-pulse 1.5s ease-in-out infinite;
        }
        .ai-voice-btn.listening svg {
            fill: white;
        }
        @keyframes voice-pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 8px rgba(220, 38, 38, 0); }
        }
        .ai-voice-status {
            position: absolute;
            bottom: 58px;
            right: 12px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            display: none;
            white-space: nowrap;
        }
        .ai-voice-status.show {
            display: block;
        }
        .ai-voice-unsupported {
            display: none;
            color: #9ca3af;
            font-size: 0.75rem;
            text-align: center;
            margin-top: 4px;
        }
    </style>

    <!-- Floating AI Button -->
    <button class="ai-fab" onclick="openAIModal()" title="AI Assistant">
        <div class="ai-fab-pulse"></div>
        <svg viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
        <span>AI Assistant</span>
    </button>

    <!-- AI Modal -->
    <div class="ai-modal-overlay" id="aiModal">
        <div class="ai-modal">
            <div class="ai-modal-header">
                <h3><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg> AI Assistant</h3>
                <button class="ai-modal-close" onclick="closeAIModal()">&times;</button>
            </div>
            <div class="ai-modal-body">
                <div class="ai-input-area" id="aiDropZone">
                    <textarea id="aiInput" placeholder="Tell me what to do... or drag & drop a file

Examples:
 Add a contact named Ted at Accurate Metal
 Log a call with Eurotech about prototype timeline
 Drag an email to extract contacts"></textarea>
                    <button class="ai-voice-btn" id="aiVoiceBtn" onclick="toggleVoiceInput()" title="Voice input">
                        <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                    </button>
                    <div class="ai-voice-status" id="aiVoiceStatus">Listening...</div>
                    <div class="ai-drop-overlay" id="aiDropOverlay">
                        <div class="ai-drop-icon"></div>
                        <div>Drop file here</div>
                    </div>
                </div>
                <div class="ai-file-preview" id="aiFilePreview"></div>

                <div class="ai-examples">
                    <div class="ai-examples-title">Quick Actions</div>
                    <div class="ai-example" onclick="setAIExample('Add a new contact: John Smith at Eurotech, email john@eurotech.com')">Add a contact</div>
                    <div class="ai-example" onclick="setAIExample('Log a call with Al Shurooq - discussed pricing for 10 units')">Log an activity</div>
                    <div class="ai-example" onclick="setAIExample('Update Eurotech status to Proposal')">Update partner status</div>
                    <div class="ai-example" onclick="setAIExample('Add note to Rainbow: Need to follow up on samples')">Add a note</div>
                </div>

                <div class="ai-actions">
                    <button class="ai-btn ai-btn-secondary" onclick="closeAIModal()">Cancel</button>
                    <button class="ai-btn ai-btn-primary" id="aiSubmitBtn" onclick="submitAIRequest()">
                        <span id="aiSubmitText">Send to AI</span>
                    </button>
                </div>

                <div class="ai-response" id="aiResponse">
                    <div class="ai-response-title" id="aiResponseTitle"></div>
                    <div id="aiResponseBody"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // AI Modal Functions
        let aiFileContent = null;
        let aiFileName = null;

        function openAIModal() {
            document.getElementById('aiModal').classList.add('active');
            document.getElementById('aiInput').focus();
        }

        function closeAIModal() {
            document.getElementById('aiModal').classList.remove('active');
            document.getElementById('aiInput').value = '';
            document.getElementById('aiResponse').className = 'ai-response';
            clearAIFile();
        }

        function setAIExample(text) {
            document.getElementById('aiInput').value = text;
            document.getElementById('aiInput').focus();
        }

        // Drag and Drop handling
        function setupDragDrop() {
            const dropZone = document.getElementById('aiDropZone');
            const textarea = document.getElementById('aiInput');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
                dropZone.addEventListener(event, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });

            ['dragenter', 'dragover'].forEach(event => {
                dropZone.addEventListener(event, () => {
                    dropZone.classList.add('drag-over');
                });
            });

            ['dragleave', 'drop'].forEach(event => {
                dropZone.addEventListener(event, () => {
                    dropZone.classList.remove('drag-over');
                });
            });

            dropZone.addEventListener('drop', handleFileDrop);

            // Also handle paste
            textarea.addEventListener('paste', handlePaste);
        }

        function handleFileDrop(e) {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handlePaste(e) {
            const items = e.clipboardData?.items;
            if (!items) return;

            for (let item of items) {
                if (item.kind === 'file') {
                    e.preventDefault();
                    const file = item.getAsFile();
                    processFile(file);
                    return;
                }
            }
        }

        function processFile(file) {
            const maxSize = 100 * 1024; // 100KB limit
            if (file.size > maxSize) {
                alert('File too large. Maximum size is 100KB.');
                return;
            }

            const allowedTypes = ['text/plain', 'text/html', 'text/csv', 'application/json', 'message/rfc822', ''];
            const allowedExtensions = ['.txt', '.html', '.htm', '.csv', '.json', '.eml', '.msg', '.md'];

            const ext = '.' + file.name.split('.').pop().toLowerCase();
            if (!allowedTypes.includes(file.type) && !allowedExtensions.includes(ext)) {
                alert('Unsupported file type. Please use text, HTML, CSV, JSON, or email files.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                aiFileContent = e.target.result;
                aiFileName = file.name;
                showFilePreview(file);

                // Pre-fill with instruction
                const input = document.getElementById('aiInput');
                if (!input.value.trim()) {
                    input.value = `Parse this ${ext.replace('.', '')} file and extract any contacts, companies, or actionable items for the CRM:`;
                }
            };
            reader.readAsText(file);
        }

        function showFilePreview(file) {
            const preview = document.getElementById('aiFilePreview');
            const size = file.size < 1024 ? `${file.size} B` : `${(file.size / 1024).toFixed(1)} KB`;
            const icon = getFileIcon(file.name);

            preview.innerHTML = `
                <span class="file-icon">${icon}</span>
                <div class="file-info">
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${size}</div>
                </div>
                <button class="file-remove" onclick="clearAIFile()" title="Remove file">&times;</button>
            `;
            preview.classList.add('active');
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'txt': '', 'md': '', 'html': '', 'htm': '',
                'csv': '', 'json': '', 'eml': '', 'msg': ''
            };
            return icons[ext] || '';
        }

        function clearAIFile() {
            aiFileContent = null;
            aiFileName = null;
            const preview = document.getElementById('aiFilePreview');
            preview.classList.remove('active');
            preview.innerHTML = '';
        }

        // Initialize drag/drop when modal opens
        document.addEventListener('DOMContentLoaded', setupDragDrop);

        // Voice Input using Web Speech API
        let recognition = null;
        let isListening = false;

        function initVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                // Hide voice button if not supported
                const voiceBtn = document.getElementById('aiVoiceBtn');
                if (voiceBtn) voiceBtn.style.display = 'none';
                console.log('Speech recognition not supported');
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                isListening = true;
                document.getElementById('aiVoiceBtn').classList.add('listening');
                document.getElementById('aiVoiceStatus').classList.add('show');
                document.getElementById('aiVoiceStatus').textContent = 'Listening...';
            };

            recognition.onend = () => {
                isListening = false;
                document.getElementById('aiVoiceBtn').classList.remove('listening');
                document.getElementById('aiVoiceStatus').classList.remove('show');
            };

            recognition.onerror = (event) => {
                console.log('Speech recognition error:', event.error);
                isListening = false;
                document.getElementById('aiVoiceBtn').classList.remove('listening');
                document.getElementById('aiVoiceStatus').textContent = 'Error: ' + event.error;
                setTimeout(() => {
                    document.getElementById('aiVoiceStatus').classList.remove('show');
                }, 2000);
            };

            recognition.onresult = (event) => {
                const input = document.getElementById('aiInput');
                let finalTranscript = '';
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                // Show interim results in status
                if (interimTranscript) {
                    document.getElementById('aiVoiceStatus').textContent = interimTranscript.substring(0, 40) + (interimTranscript.length > 40 ? '...' : '');
                }

                // Append final transcript to input
                if (finalTranscript) {
                    const currentValue = input.value.trim();
                    input.value = currentValue ? currentValue + ' ' + finalTranscript : finalTranscript;
                    input.focus();
                }
            };
        }

        function toggleVoiceInput() {
            if (!recognition) {
                initVoiceRecognition();
                if (!recognition) {
                    alert('Voice input is not supported in your browser. Try Chrome, Safari, or Edge.');
                    return;
                }
            }

            if (isListening) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (e) {
                    // Already started, stop and restart
                    recognition.stop();
                    setTimeout(() => recognition.start(), 100);
                }
            }
        }

        // Initialize voice recognition on page load
        document.addEventListener('DOMContentLoaded', initVoiceRecognition);

        async function submitAIRequest() {
            const input = document.getElementById('aiInput').value.trim();
            if (!input && !aiFileContent) return;

            const submitBtn = document.getElementById('aiSubmitBtn');
            const submitText = document.getElementById('aiSubmitText');
            const response = document.getElementById('aiResponse');
            const responseTitle = document.getElementById('aiResponseTitle');
            const responseBody = document.getElementById('aiResponseBody');

            // Show loading state
            submitBtn.disabled = true;
            submitText.innerHTML = '<span class="ai-spinner"></span>';
            response.className = 'ai-response pending';
            responseTitle.innerHTML = '<span class="ai-spinner"></span> Processing...';
            responseBody.textContent = aiFileContent ? 'AI is analyzing your file...' : 'AI is analyzing your request...';

            try {
                // Get current CRM data for context
                const partners = await loadPartnersForAI();

                // Build request with optional file content
                const requestBody = {
                    input,
                    partners: partners.map(p => ({
                        id: p.id,
                        name: p.name,
                        status: p.status,
                        contactType: p.contactType
                    }))
                };

                // Include file content if present
                if (aiFileContent) {
                    requestBody.fileContent = aiFileContent;
                    requestBody.fileName = aiFileName;
                }

                const res = await fetch('/api/ai-crm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await res.json();

                if (data.success) {
                    // Execute the actions
                    const results = await executeAIActions(data.actions);

                    response.className = 'ai-response success';
                    responseTitle.innerHTML = ' Done!';
                    responseBody.innerHTML = results.map(r => `<div>${r}</div>`).join('');

                    // Refresh the CRM view
                    await loadData();
                    renderList();

                    // Clear input and file after success
                    document.getElementById('aiInput').value = '';
                    clearAIFile();
                } else {
                    response.className = 'ai-response error';
                    responseTitle.innerHTML = ' Error';
                    responseBody.textContent = data.error || 'Could not process request';
                }
            } catch (err) {
                response.className = 'ai-response error';
                responseTitle.innerHTML = ' Error';
                responseBody.textContent = err.message || 'Failed to connect to AI service';
            }

            submitBtn.disabled = false;
            submitText.textContent = 'Send to AI';
        }

        async function loadPartnersForAI() {
            const { data, error } = await supabaseClient.from('partners').select('id, name, status, contactType');
            return data || [];
        }

        async function executeAIActions(actions) {
            const results = [];

            for (const action of actions) {
                try {
                    switch (action.type) {
                        case 'add_contact':
                            await addContactFromAI(action.partnerId, action.contact);
                            results.push(`Added contact ${action.contact.name} to ${action.partnerName}`);
                            break;

                        case 'add_activity':
                            await addActivityFromAI(action.partnerId, action.activity);
                            results.push(`Logged ${action.activity.type}: "${action.activity.notes}" for ${action.partnerName}`);
                            break;

                        case 'update_status':
                            await updateStatusFromAI(action.partnerId, action.status);
                            results.push(`Updated ${action.partnerName} status to ${action.status}`);
                            break;

                        case 'add_note':
                            await addActivityFromAI(action.partnerId, { type: 'Note', notes: action.note });
                            results.push(`Added note to ${action.partnerName}`);
                            break;

                        case 'create_partner':
                            await createPartnerFromAI(action.partner);
                            results.push(`Created new partner: ${action.partner.name}`);
                            break;

                        default:
                            results.push(`Unknown action: ${action.type}`);
                    }
                } catch (err) {
                    results.push(`Failed: ${err.message}`);
                }
            }

            return results;
        }

        async function addContactFromAI(partnerId, contact) {
            const { error } = await supabase.from('partner_contacts').insert({
                id: 'contact_' + Date.now(),
                partner_id: partnerId,
                name: contact.name,
                email: contact.email || null,
                phone: contact.phone || null,
                role: contact.role || 'Contact',
                created_at: new Date().toISOString()
            });
            if (error) throw error;
        }

        async function addActivityFromAI(partnerId, activity) {
            const { error } = await supabase.from('partner_activities').insert({
                id: 'activity_' + Date.now(),
                partner_id: partnerId,
                type: activity.type,
                notes: activity.notes,
                created_at: new Date().toISOString()
            });
            if (error) throw error;
        }

        async function updateStatusFromAI(partnerId, status) {
            const { error } = await supabase.from('partners').update({
                status,
                updated_at: new Date().toISOString()
            }).eq('id', partnerId);
            if (error) throw error;
        }

        async function createPartnerFromAI(partner) {
            const { error } = await supabase.from('partners').insert({
                id: 'partner_' + Date.now(),
                name: partner.name,
                status: partner.status || 'Lead',
                contactType: partner.contactType || 'partner',
                notes: partner.notes || '',
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            });
            if (error) throw error;
        }

        // Close modal on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('aiModal').classList.contains('active')) {
                closeAIModal();
            }
        });
    </script>
</body>
</html>
